<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ø­Ø§Ø³Ø¨Ø© Ø¨Ù„ÙˆØª</title>
  <style>
    :root{
      --bg1:#07110e;
      --bg2:#0c1713;
      --card: rgba(9,22,18,.68);
      --glass: rgba(13,30,24,.70);
      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.16);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --gold:#f3c34f;
      --red:#ff4b4b;
      --green:#33d17a;

      --shadow: 0 14px 35px rgba(0,0,0,.38);
      --r12:12px; --r16:16px; --r18:18px; --r22:22px; --r28:28px;
    }

    /* Light theme overrides (apply on body.light) */
    body.light{
      --bg1:#f3f6f4;
      --bg2:#e9f0ec;
      --card: rgba(255,255,255,.78);
      --glass: rgba(255,255,255,.70);
      --border: rgba(17,24,39,.10);
      --border2: rgba(17,24,39,.16);

      --text: rgba(17,24,39,.92);
      --muted: rgba(17,24,39,.60);

      --shadow: 0 12px 28px rgba(0,0,0,.12);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Tahoma,Arial,sans-serif;
      background:
        radial-gradient(1000px 500px at 50% -120px, rgba(35,130,95,.18), transparent 60%),
        radial-gradient(900px 420px at 15% 10%, rgba(243,195,79,.10), transparent 55%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--text);
      min-height:100vh;
    }

    .wrap{max-width: 980px; margin:0 auto; padding:22px 16px 40px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:999px;
      background: var(--glass); border:1px solid var(--border);
      box-shadow: var(--shadow); backdrop-filter: blur(10px);
      color: var(--muted); font-weight:800;
    }
    .badge b{color: var(--gold)}
    .title{
      flex:1; min-width: 220px;
      display:flex; justify-content:center; align-items:center; gap:10px;
      font-size:28px; font-weight:950; color: var(--gold);
      text-shadow: 0 0 18px rgba(243,195,79,.14);
    }
    .rightActions{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .iconBtn{
      width:42px; height:42px; display:grid; place-items:center;
      border-radius:999px; background: var(--glass);
      border:1px solid var(--border); box-shadow: var(--shadow);
      cursor:pointer; user-select:none; transition:.15s;
    }
    .iconBtn:hover{transform: translateY(-1px); border-color: var(--border2);}

    .pillBtn{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px; border-radius:999px;
      border:1px solid rgba(255,75,75,.32);
      background: rgba(255,75,75,.10);
      color: var(--red);
      font-weight:950;
      box-shadow: var(--shadow);
      cursor:pointer; user-select:none; transition:.15s;
    }
    .pillBtn:hover{transform: translateY(-1px);}

    /* Timer */
    .timerWrap{margin-top: 14px; display:flex; justify-content:center;}
    .timer{
      display:flex; align-items:center; gap:12px;
      padding:10px 14px; border-radius:16px;
      background: var(--glass); border:1px solid var(--border);
      box-shadow: var(--shadow); backdrop-filter: blur(10px);
    }
    .tBtn{
      width:34px; height:34px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      display:grid; place-items:center;
      cursor:pointer; user-select:none; transition:.15s;
    }
    .tBtn:hover{border-color: var(--border2)}
    .tBtn.red{color: var(--red)}
    .tBtn.green{color: var(--green)}
    .tTime{min-width:92px; text-align:center; font-size:24px; font-weight:950; letter-spacing:1px;}

    /* Goal bar */
    .goalRow{
      margin-top: 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      color: var(--muted); font-weight:850;
    }
    .goalRow .left{color: var(--red)}
    .goalRow .right{color: var(--green)}
    .goalRow .mid{color: var(--gold)}
    .progressOuter{
      margin-top:8px; height:14px; border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--border);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }
    .progressInner{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(51,209,122,.92), rgba(243,195,79,.75));
      border-radius:999px;
      transition: width .2s ease;
    }

    /* Teams grid */
    .teams{margin-top:16px; display:grid; grid-template-columns:1fr; gap:14px;}
    @media (min-width: 820px){ .teams{grid-template-columns: 1fr 1fr;} }

    .teamCard{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--r18);
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
      display:flex; flex-direction:column; gap:12px;
      min-height: 260px;
    }
    .teamCard.red{ outline:1px solid rgba(255,75,75,.22); }
    .teamCard.green{ outline:1px solid rgba(51,209,122,.22); }

    .teamTop{
      display:flex; align-items:center; justify-content:center; gap:10px;
      font-weight:950; font-size:22px;
    }
    .teamTop .edit{opacity:.7; font-size:16px; cursor:pointer; user-select:none;}
    .teamTop.redText{color: var(--red)}
    .teamTop.greenText{color: var(--green)}

    .score{
      text-align:center; font-size:72px; font-weight:1000;
      letter-spacing:1px; margin-top:2px;
      text-shadow: 0 0 30px rgba(0,0,0,.28);
    }

    /* Buttons */
    .addBtn{
      width:100%;
      padding: 14px 14px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      font-weight:950;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:10px;
      user-select:none; transition:.15s;
    }
    .teamCard.red .addBtn{
      border-color: rgba(255,75,75,.28);
      background: rgba(255,75,75,.10);
      color: var(--red);
    }
    .teamCard.green .addBtn{
      border-color: rgba(51,209,122,.28);
      background: rgba(51,209,122,.10);
      color: var(--green);
    }
    .addBtn:hover{transform: translateY(-1px); border-color: var(--border2);}

    /* Tabs */
    .tabs{
      margin-top: 14px;
      display:flex; gap:10px;
      padding:8px;
      background: var(--glass);
      border:1px solid var(--border);
      border-radius: var(--r16);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .tab{
      flex:1;
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:950;
      color: var(--muted);
      border:1px solid transparent;
      background: transparent;
      user-select:none;
      display:flex; justify-content:center; align-items:center; gap:8px;
    }
    .tab.active{
      background: rgba(255,255,255,.06);
      border-color: var(--border);
      color: var(--text);
    }

    .box{
      margin-top: 12px;
      border-radius: var(--r18);
      border:1px solid var(--border);
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(10px);
    }
    .boxHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom: 10px;
    }
    .boxTitle{display:flex; align-items:center; gap:10px; font-weight:1000;}
    .boxTitle small{color: var(--muted); font-weight:850}

    .smallBtns{display:flex; gap:8px; flex-wrap:wrap;}
    .smBtn{
      border-radius: 999px;
      padding: 9px 12px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      color: var(--text);
      cursor:pointer;
      font-weight:950;
      font-size:13px;
      user-select:none;
      transition:.15s;
    }
    .smBtn:hover{border-color: var(--border2)}
    .smBtn.danger{
      color: var(--red);
      border-color: rgba(255,75,75,.28);
      background: rgba(255,75,75,.10);
    }

    .empty{padding: 34px 12px; text-align:center; color: var(--muted); font-weight:850;}
    .list{display:flex; flex-direction:column; gap:10px;}

    .rowItem{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      font-weight:950;
      align-items:center;
    }
    .rowItem small{color: var(--muted); font-weight:850}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-weight:950;
      font-size:12px;
      margin-inline-start: 8px;
    }

    .statsGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 820px){
      .statsGrid{grid-template-columns: 1fr 1fr;}
    }
    .statCard{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:950;
    }
    .statCard .k{color: var(--muted); font-weight:900}

    .seg{
      display:flex; gap:8px; padding:6px; border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
    }
    .seg button{
      flex:1;
      padding:10px 10px;
      border-radius:999px;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      font-weight:950;
      cursor:pointer;
      user-select:none;
      transition:.15s;
    }
    .seg button.active{
      background: rgba(255,255,255,.06);
      border-color: var(--border);
      color: var(--text);
    }

    label{display:block; font-size:12px; color: var(--muted); margin:0 0 6px;}
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
      font-weight:850;
    }
    body.light input, body.light select{ background: rgba(17,24,39,.04); }
    input:focus, select:focus{border-color: var(--border2)}
    select option{color:#111827}

    .noteBottom{
      margin-top: 18px;
      text-align:center;
      color: rgba(243,195,79,.82);
      font-weight:900;
      font-size: 13px;
      line-height:1.6;
    }

    .toast{
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 18px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(17,24,39,.92);
      color:#fff;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      font-weight:950;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index: 160;
    }
    .toast.show{opacity:1}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="badge">Ø§Ù„Ø¬ÙˆÙ„Ø© <b id="roundNo">0</b></div>
      <div class="title">Ø­Ø§Ø³Ø¨Ø© Ø¨Ù„ÙˆØª <span>ğŸ†</span></div>

      <div class="rightActions">
        <div class="iconBtn" id="themeBtn" title="ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ">ğŸŒ™</div>
        <div class="iconBtn" id="soundBtn" title="ØµÙˆØª">ğŸ”Š</div>
        <div class="pillBtn" id="newBtn">Ø¬Ø¯ÙŠØ¯ â†º</div>
      </div>
    </div>

    <!-- Round timer -->
    <div class="timerWrap">
      <div class="timer">
        <div class="tBtn red" id="resetTimerBtn" title="ØªØµÙÙŠØ± Ø§Ù„Ù…Ø¤Ù‚Øª">â†º</div>
        <div class="tBtn green" id="startPauseBtn" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù">â–¶</div>
        <div class="tTime" id="timerTxt">00:00</div>
        <div class="tBtn" id="stopBtn" title="Ø¥ÙŠÙ‚Ø§Ù">â±</div>
      </div>
    </div>

    <!-- Goal + progress -->
    <div class="goalRow">
      <div class="left">Ù‡Ù…: <span id="pThem">0%</span></div>
      <div class="mid">Ø§Ù„Ù‡Ø¯Ù: <span id="goalTxt">152</span></div>
      <div class="right">Ù†Ø­Ù†: <span id="pUs">0%</span></div>
    </div>
    <div class="progressOuter"><div class="progressInner" id="progress"></div></div>

    <!-- Teams -->
    <div class="teams">
      <!-- THEM -->
      <div class="teamCard red" id="cardThem">
        <div class="teamTop redText">
          <span class="edit" data-edit="them" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…">âœ</span>
          <span id="themName">Ù‡Ù…</span>
        </div>
        <div class="score" id="themScore">0</div>
        <button class="addBtn" id="addThem">Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø© <span style="font-size:18px">ï¼‹</span></button>
      </div>

      <!-- US -->
      <div class="teamCard green" id="cardUs">
        <div class="teamTop greenText">
          <span class="edit" data-edit="us" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…">âœ</span>
          <span id="usName">Ù†Ø­Ù†</span>
        </div>
        <div class="score" id="usScore">0</div>
        <button class="addBtn" id="addUs">Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø© <span style="font-size:18px">ï¼‹</span></button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" id="tabHistory">â†© Ø§Ù„Ø³Ø¬Ù„</div>
      <div class="tab" id="tabStats">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
    </div>

    <!-- History -->
    <div class="box" id="historyBox">
      <div class="boxHead">
        <div class="boxTitle">ğŸ•’ Ø³Ø¬Ù„ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª <small>(<span id="count">0</span>)</small></div>
        <div class="smallBtns">
          <button class="smBtn" id="shareBtn">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</button>
          <button class="smBtn" id="undoBtn">â†© ØªØ±Ø§Ø¬Ø¹</button>
          <button class="smBtn danger" id="clearBtn">ğŸ—‘ Ù…Ø³Ø­</button>
        </div>
      </div>
      <div id="historyBody" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬ÙˆÙ„Ø§Øª Ø¨Ø¹Ø¯</div>
    </div>

    <!-- Stats -->
    <div class="box" id="statsBox" style="display:none;">
      <div class="boxHead">
        <div class="boxTitle">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
      </div>

      <div class="statsGrid">
        <div class="statCard"><div class="k">Ù…Ø¬Ù…ÙˆØ¹ Ù†Ø­Ù†</div><div><b id="stUs">0</b> <span class="chip">Ù†Ù‚Ø·Ø©</span></div></div>
        <div class="statCard"><div class="k">Ù…Ø¬Ù…ÙˆØ¹ Ù‡Ù…</div><div><b id="stThem">0</b> <span class="chip">Ù†Ù‚Ø·Ø©</span></div></div>
        <div class="statCard"><div class="k">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª</div><div><b id="stAdds">0</b></div></div>
        <div class="statCard"><div class="k">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù†Ù‚Ø§Ø·/Ø¥Ø¶Ø§ÙØ©</div><div><b id="stAvg">0</b></div></div>
        <div class="statCard"><div class="k">Ø£Ø¹Ù„Ù‰ Ø¥Ø¶Ø§ÙØ©</div><div><b id="stMax">0</b></div></div>
        <div class="statCard"><div class="k">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ÙÙˆØ²</div><div><b id="stRemain">152</b></div></div>
        <div class="statCard"><div class="k">Ù…Ø´Ø§Ø±ÙŠØ¹ Ù†Ø­Ù†</div><div><b id="stUsProj">0</b></div></div>
        <div class="statCard"><div class="k">Ù…Ø´Ø§Ø±ÙŠØ¹ Ù‡Ù…</div><div><b id="stThemProj">0</b></div></div>
      </div>
    </div>

    <div class="noteBottom">
  </div>

  <div class="toast" id="toast">âœ… ØªÙ…</div>

  <!-- Add Result Modal -->
  <div id="addModal" style="display:none; position:fixed; inset:0; z-index:150; background:rgba(0,0,0,.55);">
    <div style="max-width:560px; margin:6vh auto; padding:14px;">
      <div style="background:var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); backdrop-filter: blur(12px); overflow:hidden;">

        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border);">
          <div style="font-weight:1000; color:var(--text);" id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø©</div>
          <div id="closeModal" class="iconBtn" style="width:38px;height:38px;">âœ•</div>
        </div>

        <div style="padding:14px; display:flex; flex-direction:column; gap:12px;">

          <!-- Mode: Manual / Advanced -->
          <div>
            <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</label>
            <div class="seg">
              <button id="mManual" class="active">ÙŠØ¯ÙˆÙŠ</button>
              <button id="mAdvanced">Ù…ØªÙ‚Ø¯Ù…</button>
            </div>
          </div>

          <!-- MANUAL -->
          <div id="manualBox" class="box" style="margin:0;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div>
                <label id="manualUsLbl">Ù†Ù‚Ø§Ø· Ù†Ø­Ù†</label>
                <input id="manualUsPts" type="number" min="0" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 30" />
              </div>
              <div>
                <label id="manualThemLbl">Ù†Ù‚Ø§Ø· Ù‡Ù…</label>
                <input id="manualThemPts" type="number" min="0" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 20" />
              </div>
              <div style="grid-column:1/-1;">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="manualNote" type="text" placeholder="..." />
              </div>
            </div>
          </div>

          <!-- ADVANCED -->
          <div id="advancedBox" class="box" style="margin:0; display:none;">
            <div>
              <label>Ù†ÙˆØ¹ Ø§Ù„Ù„Ø¹Ø¨Ø©</label>
              <div class="seg">
                <button id="advSan" class="active">ØµÙ† â˜€ï¸</button>
                <button id="advHokm">Ø­ÙƒÙ… â™›</button>
              </div>
              <div style="margin-top:8px; color:var(--muted); font-weight:850; font-size:12px;">
                Ø§Ù„Ø£Ø¨Ù†Ø§Ø·: ØµÙ† Ã·5 (Ø«Ø§Ø¨Øª 24) â€” Ø­ÙƒÙ… Ã·10 (Ø«Ø§Ø¨Øª 15)
              </div>
            </div>

            <div style="margin-top:10px; display:grid; grid-template-columns:1fr; gap:10px;">
              <div>
                <label>Ø§Ù„Ø£Ø¨Ù†Ø§Ø·</label>
                <input id="advAbnat" type="number" min="0" inputmode="numeric" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£Ø¨Ù†Ø§Ø·..." />
              </div>

              <div>
                <label>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</label>
                <select id="advProj"></select>
              </div>
              

              <div>
                <label>Ø§Ù„Ø£Ø±Ø¶ (Ù„Ù…Ù†ØŸ)</label>
                <div class="seg">
                  <button id="ardUs" class="active">Ù†Ø­Ù†</button>
                  <button id="ardThem">Ù‡Ù…</button>
                </div>
                <div style="margin-top:8px; color:var(--muted); font-weight:850; font-size:12px;">
                  Ø§Ù„Ø£Ø±Ø¶: ØµÙ† +2 ØŒ Ø­ÙƒÙ… +1
                </div>
              </div>

              <div>
                <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="advNote" type="text" placeholder="..." />
              </div>

              <div style="border-top:1px solid var(--border); padding-top:12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; font-weight:1000;">
                  <div>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</div>
                  <div style="display:flex; gap:10px; align-items:center;">
                    <span style="color:var(--muted); font-weight:900;" id="advPreviewUs">Ù†Ø­Ù†: 0</span>
                    <span style="color:var(--muted); font-weight:900;" id="advPreviewThem">Ù‡Ù…: 0</span>
                  </div>
                </div>
                <div style="margin-top:8px; color:var(--muted); font-weight:850; font-size:12px;" id="advDetails"></div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div style="display:flex; gap:10px;">
            <button id="modalAddBtn" class="addBtn" style="flex:1;">Ø¥Ø¶Ø§ÙØ©</button>
            <button id="modalClearBtn" class="addBtn" style="flex:1; background:rgba(255,255,255,.04); color:var(--text); border-color:var(--border);">Ù…Ø³Ø­</button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    const LS = "baloot_magic_v3";

    const $ = (id)=>document.getElementById(id);

    const el = {
      roundNo: $("roundNo"),
      goalTxt: $("goalTxt"),
      progress: $("progress"),
      pUs: $("pUs"),
      pThem: $("pThem"),

      usName: $("usName"),
      themName: $("themName"),
      usScore: $("usScore"),
      themScore: $("themScore"),

      addUs: $("addUs"),
      addThem: $("addThem"),

      tabHistory: $("tabHistory"),
      tabStats: $("tabStats"),
      historyBox: $("historyBox"),
      statsBox: $("statsBox"),

      historyBody: $("historyBody"),
      count: $("count"),

      shareBtn: $("shareBtn"),
      undoBtn: $("undoBtn"),
      clearBtn: $("clearBtn"),
      newBtn: $("newBtn"),

      themeBtn: $("themeBtn"),
      soundBtn: $("soundBtn"),

      resetTimerBtn: $("resetTimerBtn"),
      startPauseBtn: $("startPauseBtn"),
      stopBtn: $("stopBtn"),
      timerTxt: $("timerTxt"),

      toast: $("toast"),

      stUs: $("stUs"),
      stThem: $("stThem"),
      stAdds: $("stAdds"),
      stAvg: $("stAvg"),
      stMax: $("stMax"),
      stRemain: $("stRemain"),
      stUsProj: $("stUsProj"),
      stThemProj: $("stThemProj"),
    };

    const defaultState = {
      goal: 152,
      usName: "Ù†Ø­Ù†",
      themName: "Ù‡Ù…",
      // entries: {team:"us|them", kind:"manual|advanced", mode:"san|hokm|manual", totalPts:number, round:number, at:number, timeSec:number, detail:string, projPts:number}
      entries: [],
      round: 0,
      theme: "dark",
      sound: true,
      timer: { sec:0, running:false }
    };

    function safeLoad(){
      try{
        const raw = localStorage.getItem(LS);
        if(!raw) return null;
        const s = JSON.parse(raw);
        if(!s || typeof s !== "object") return null;
        if(typeof s.goal !== "number") s.goal = 152;
        if(typeof s.usName !== "string") s.usName = "Ù†Ø­Ù†";
        if(typeof s.themName !== "string") s.themName = "Ù‡Ù…";
        if(!Array.isArray(s.entries)) s.entries = [];
        if(typeof s.round !== "number") s.round = 0;
        if(!s.timer) s.timer = {sec:0,running:false};
        if(typeof s.timer.sec !== "number") s.timer.sec = 0;
        if(typeof s.timer.running !== "boolean") s.timer.running = false;
        if(s.theme !== "light" && s.theme !== "dark") s.theme = "dark";
        if(typeof s.sound !== "boolean") s.sound = true;
        return s;
      }catch{ return null; }
    }

    let state = safeLoad() || structuredClone(defaultState);

    function save(){
      localStorage.setItem(LS, JSON.stringify(state));
    }

    function sumTeam(team){
      return state.entries.filter(e=>e.team===team).reduce((a,e)=>a+(e.totalPts||0),0);
    }

    function formatTime(sec){
      sec = Math.max(0, sec|0);
      const m = String(Math.floor(sec/60)).padStart(2,"0");
      const s = String(sec%60).padStart(2,"0");
      return `${m}:${s}`;
    }

    // -------------------- Sound --------------------
    let audioCtx = null;
    function beep(type){
      if(!state.sound) return;
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);

        const now = audioCtx.currentTime;
        const freq = type === "add" ? 660 : type === "undo" ? 420 : type === "clear" ? 220 : 520;

        o.frequency.setValueAtTime(freq, now);
        o.type = "sine";
        g.gain.setValueAtTime(0.0001, now);
        g.gain.exponentialRampToValueAtTime(0.12, now + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);

        o.start(now);
        o.stop(now + 0.14);
      }catch{}
    }

    function toast(msg){
      el.toast.textContent = msg;
      el.toast.classList.add("show");
      setTimeout(()=>el.toast.classList.remove("show"), 1100);
    }

    // -------------------- Theme --------------------
    function applyTheme(){
      document.body.classList.toggle("light", state.theme === "light");
      el.themeBtn.textContent = state.theme === "light" ? "â˜€ï¸" : "ğŸŒ™";
    }

    // -------------------- Timer --------------------
    let timerInt = null;
    function tick(){
      if(!state.timer.running) return;
      state.timer.sec = (state.timer.sec||0) + 1;
      render();
    }
    function ensureTimer(){
      if(timerInt) return;
      timerInt = setInterval(tick, 1000);
    }

    // -------------------- Modal (Manual / Advanced) --------------------
    const modal = {
      wrap: $("addModal"),
      title: $("modalTitle"),
      close: $("closeModal"),

      mManual: $("mManual"),
      mAdvanced: $("mAdvanced"),
      manualBox: $("manualBox"),
      advancedBox: $("advancedBox"),

      manualUsLbl: $("manualUsLbl"),
      manualThemLbl: $("manualThemLbl"),
      manualUsPts: $("manualUsPts"),
      manualThemPts: $("manualThemPts"),
      manualNote: $("manualNote"),

      advSan: $("advSan"),
      advHokm: $("advHokm"),
      advAbnat: $("advAbnat"),
      advProj: $("advProj"),
      ardUs: $("ardUs"),
      ardThem: $("ardThem"),
      advNote: $("advNote"),
      advPreviewUs: $("advPreviewUs"),
      advPreviewThem: $("advPreviewThem"),
      advDetails: $("advDetails"),

      addBtn: $("modalAddBtn"),
      clearBtn: $("modalClearBtn"),
    };

    let modalTeam = "us";
    let modalMode = "manual"; // manual | advanced
    let advMode = "san";      // san | hokm
    let advArd = "us";        // us | them

    // Projects tables Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ
    const projSan = [
      {key:"", label:"Ø¨Ø¯ÙˆÙ†", pts:0},
      {key:"sra", label:"Ø³Ø±Ø§ (+4)", pts:4},
      {key:"50", label:"Ø®Ù…Ø³ÙŠÙ† (+10)", pts:10},
      {key:"100", label:"Ù…ÙŠØ© (+20)", pts:20},
      {key:"400", label:"400 (+40)", pts:40},
    ];
    const projHokm = [
      {key:"", label:"Ø¨Ø¯ÙˆÙ†", pts:0},
      {key:"sra", label:"Ø³Ø±Ø§ (+2)", pts:2},
      {key:"50", label:"Ø®Ù…Ø³ÙŠÙ† (+5)", pts:5},
      {key:"100", label:"Ù…ÙŠØ© (+10)", pts:10},
      {key:"baloot", label:"Ø¨Ù„ÙˆØª (+2)", pts:2},
    ];

    function setModalMode(m){
      modalMode = m;
      modal.mManual.classList.toggle("active", m==="manual");
      modal.mAdvanced.classList.toggle("active", m==="advanced");
      modal.manualBox.style.display = m==="manual" ? "" : "none";
      modal.advancedBox.style.display = m==="advanced" ? "" : "none";
    }

    function setAdvButtons(){
      modal.advSan.classList.toggle("active", advMode==="san");
      modal.advHokm.classList.toggle("active", advMode==="hokm");
    }

    function setArdButtons(){
      modal.ardUs.classList.toggle("active", advArd==="us");
      modal.ardThem.classList.toggle("active", advArd==="them");
    }

    function fillProjects(){
      modal.advProj.innerHTML = "";
      const arr = (advMode==="san") ? projSan : projHokm;
      arr.forEach(p=>{
        const opt = document.createElement("option");
        opt.value = p.key;
        opt.textContent = p.label;
        modal.advProj.appendChild(opt);
      });
    }

    function clearModalInputs(){
      modal.manualUsPts.value = "";
      modal.manualThemPts.value = "";
      modal.manualNote.value = "";

      modal.advAbnat.value = "";
      modal.advProj.value = "";
      modal.advNote.value = "";
    }

    function advDivisor(){ return advMode === "hokm" ? 10 : 5; }
    function advFixed(){ return advMode === "hokm" ? 15 : 24; }
    function ardBonus(){ return advMode === "hokm" ? 1 : 2; }

    function getProjPts(){
      const key = modal.advProj.value || "";
      const arr = (advMode==="san") ? projSan : projHokm;
      const found = arr.find(x=>x.key===key);
      return found ? found.pts : 0;
    }

    // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¨Ù†Ø§Ø· (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹):
    // Ø§Ù„Ø£Ø±Ø¶: (abnat - fixed) â€” Ø§Ù„Ø®ØµÙ…: fixed
    // Ø«Ù… Ù†Ù‚Ø³Ù… ÙƒÙ„ Ø¬Ø²Ø¡ Ã·5 Ø£Ùˆ Ã·10
    function computeAdvanced(){
      const abnat = Math.max(0, parseInt(modal.advAbnat.value||"0",10) || 0);
      const fixed = advFixed();
      const divisor = advDivisor();

      const projPts = getProjPts();
      const bonus = (modal.advAbnat.value !== "" || modal.advProj.value) ? ardBonus() : 0;

      const ardRaw = Math.max(0, abnat - fixed);
      const otherRaw = Math.max(0, fixed);

      const ardPts = Math.floor(ardRaw / divisor);
      const otherPts = Math.floor(otherRaw / divisor);

      // Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ø±Ø¶ = Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ø¨Ù†Ø§Ø· + Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ + Ø¨ÙˆÙ†Øµ Ø§Ù„Ø£Ø±Ø¶
      const ardTotal = ardPts + projPts + bonus;

      // Ø§Ù„Ø®ØµÙ… = Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ø¨Ù†Ø§Ø· ÙÙ‚Ø·
      const otherTotal = otherPts;

      const usTotal = (advArd==="us") ? ardTotal : otherTotal;
      const themTotal = (advArd==="them") ? ardTotal : otherTotal;

      // ØªÙØµÙŠÙ„ Ù„ÙƒÙ„ ÙØ±ÙŠÙ‚ (Ù„Ù„Ø³Ø¬Ù„)
      const usProjPts = (advArd==="us") ? projPts : 0;
      const themProjPts = (advArd==="them") ? projPts : 0;
      const usBonus = (advArd==="us") ? bonus : 0;
      const themBonus = (advArd==="them") ? bonus : 0;

      const usAbnatPts = (advArd==="us") ? ardPts : otherPts;
      const themAbnatPts = (advArd==="them") ? ardPts : otherPts;

      return {
        abnat, fixed, divisor,
        ardRaw, otherRaw,
        ardPts, otherPts,
        projPts, bonus,
        usTotal, themTotal,
        usProjPts, themProjPts,
        usBonus, themBonus,
        usAbnatPts, themAbnatPts
      };
    }

    function updateAdvancedPreview(){
      const r = computeAdvanced();
      modal.advPreviewUs.textContent = `${state.usName||"Ù†Ø­Ù†"}: ${r.usTotal}`;
      modal.advPreviewThem.textContent = `${state.themName||"Ù‡Ù…"}: ${r.themTotal}`;

      const ardName = advArd==="us" ? (state.usName||"Ù†Ø­Ù†") : (state.themName||"Ù‡Ù…");
      modal.advDetails.textContent =
        `Ø§Ù„Ø£Ø±Ø¶: ${ardName} â€” ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¨Ù†Ø§Ø·: (${r.abnat} - ${r.fixed} = ${r.ardRaw}) Ù„Ù„Ø£Ø±Ø¶ Ùˆ (${r.otherRaw}) Ù„Ù„Ø®ØµÙ… Ø«Ù… Ã·${r.divisor}. ` +
        `Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹: +${r.projPts} ØŒ Ø¨ÙˆÙ†Øµ Ø§Ù„Ø£Ø±Ø¶: +${r.bonus}`;
    }

    function openAddModal(team){
      modalTeam = team;

      const teamName = team==="us" ? (state.usName||"Ù†Ø­Ù†") : (state.themName||"Ù‡Ù…");
      modal.title.textContent = `Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø© - ${teamName}`;

      modal.manualUsLbl.textContent = `Ù†Ù‚Ø§Ø· ${state.usName||"Ù†Ø­Ù†"}`;
      modal.manualThemLbl.textContent = `Ù†Ù‚Ø§Ø· ${state.themName||"Ù‡Ù…"}`;

      modal.ardUs.textContent = state.usName || "Ù†Ø­Ù†";
      modal.ardThem.textContent = state.themName || "Ù‡Ù…";

      // Ø§ÙØªØ±Ø§Ø¶: Ø§Ù„Ø£Ø±Ø¶ Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù„ÙŠ ÙØªØ­
      advArd = team;
      setArdButtons();

      // Ø§ÙØªØ±Ø§Ø¶: Ù…ØªÙ‚Ø¯Ù… = ØµÙ†
      advMode = "san";
      setAdvButtons();
      fillProjects();

      // Ø§ÙØªØ±Ø§Ø¶: ØªØ¨Ø¯Ø£ ÙŠØ¯ÙˆÙŠ
      setModalMode("manual");

      clearModalInputs();
      updateAdvancedPreview();

      modal.wrap.style.display = "";
    }

    function closeAddModal(){ modal.wrap.style.display = "none"; }

    // Modal events
    modal.close.onclick = closeAddModal;
    modal.wrap.addEventListener("click",(e)=>{ if(e.target===modal.wrap) closeAddModal(); });

    modal.mManual.onclick = ()=>{ beep(); setModalMode("manual"); };
    modal.mAdvanced.onclick = ()=>{ beep(); setModalMode("advanced"); updateAdvancedPreview(); };

    modal.advSan.onclick = ()=>{ advMode="san"; beep(); setAdvButtons(); fillProjects(); updateAdvancedPreview(); };
    modal.advHokm.onclick = ()=>{ advMode="hokm"; beep(); setAdvButtons(); fillProjects(); updateAdvancedPreview(); };

    modal.ardUs.onclick = ()=>{ advArd="us"; beep(); setArdButtons(); updateAdvancedPreview(); };
    modal.ardThem.onclick = ()=>{ advArd="them"; beep(); setArdButtons(); updateAdvancedPreview(); };

    modal.advAbnat.addEventListener("input", updateAdvancedPreview);
    modal.advProj.addEventListener("change", updateAdvancedPreview);

    modal.clearBtn.onclick = ()=>{ beep("clear"); clearModalInputs(); updateAdvancedPreview(); toast("ğŸ§¹ ØªÙ…"); };

    modal.addBtn.onclick = ()=>{
      // ÙƒÙ„ Ø¥Ø¶Ø§ÙØ© ØªØ¹ØªØ¨Ø± Ø¬ÙˆÙ„Ø©
      state.round = (state.round || 0) + 1;
      const timeSec = state.timer.sec || 0;
      const at = Date.now();

      if(modalMode === "manual"){
        const usPts = Math.max(0, parseInt(modal.manualUsPts.value||"0",10) || 0);
        const themPts = Math.max(0, parseInt(modal.manualThemPts.value||"0",10) || 0);
        const note = (modal.manualNote.value||"").trim();

        if(usPts<=0 && themPts<=0 && !note){
          toast("Ø§ÙƒØªØ¨ Ù†Ù‚Ø§Ø·");
          state.round = Math.max(0, state.round-1);
          return;
        }

        // Ù†Ø³Ø¬Ù„ Ù…Ø¯Ø®Ù„ÙŠÙ† (Ù†Ø­Ù† + Ù‡Ù…)
        state.entries.push({
          team:"us",
          kind:"manual",
          mode:"manual",
          totalPts: usPts,
          projPts: 0,
          round: state.round,
          at, timeSec,
          detail: `ÙŠØ¯ÙˆÙŠ â€” ${state.usName||"Ù†Ø­Ù†"}: ${usPts} | ${state.themName||"Ù‡Ù…"}: ${themPts}${note ? " â€” "+note : ""}`
        });

        state.entries.push({
          team:"them",
          kind:"manual",
          mode:"manual",
          totalPts: themPts,
          projPts: 0,
          round: state.round,
          at, timeSec,
          detail: `ÙŠØ¯ÙˆÙŠ â€” ${state.usName||"Ù†Ø­Ù†"}: ${usPts} | ${state.themName||"Ù‡Ù…"}: ${themPts}${note ? " â€” "+note : ""}`
        });

      }else{
        const r = computeAdvanced();
        const note = (modal.advNote.value||"").trim();
        const modeTxt = advMode==="san" ? "ØµÙ†" : "Ø­ÙƒÙ…";
        const ardName = advArd==="us" ? (state.usName||"Ù†Ø­Ù†") : (state.themName||"Ù‡Ù…");
        const detail =
          `Ù…ØªÙ‚Ø¯Ù… (${modeTxt}) â€” Ø£Ø±Ø¶: ${ardName} â€” Ø£Ø¨Ù†Ø§Ø· ${r.abnat} (Ø«Ø§Ø¨Øª ${r.fixed}ØŒ Ã·${r.divisor}) â€” Ù…Ø´Ø§Ø±ÙŠØ¹ +${r.projPts} â€” Ø£Ø±Ø¶ +${r.bonus}` +
          (note ? ` â€” ${note}` : "");

        // Ø³Ø¬Ù„ Ù†Ù‚Ø·ØªÙŠÙ† (Ù†Ø­Ù† + Ù‡Ù…) Ø¨Ù†Ù‚Ø§Ø· Ù…Ø­Ø³ÙˆØ¨Ø©
        state.entries.push({
          team:"us",
          kind:"advanced",
          mode: advMode,
          totalPts: r.usTotal,
          projPts: r.usProjPts,
          round: state.round,
          at, timeSec,
          detail
        });

        state.entries.push({
          team:"them",
          kind:"advanced",
          mode: advMode,
          totalPts: r.themTotal,
          projPts: r.themProjPts,
          round: state.round,
          at, timeSec,
          detail
        });
      }

      // Ø´ØºÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ùˆ Ø·Ø§ÙÙŠ
      if(!state.timer.running){
        state.timer.running = true;
        ensureTimer();
      }

      beep("add");
      toast("âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
      closeAddModal();
      render();
    };

    // -------------------- Rendering --------------------
    function render(){
      applyTheme();

      el.soundBtn.textContent = state.sound ? "ğŸ”Š" : "ğŸ”‡";

      const us = sumTeam("us");
      const them = sumTeam("them");
      const goal = state.goal || 152;

      el.goalTxt.textContent = goal;
      el.usName.textContent = state.usName || "Ù†Ø­Ù†";
      el.themName.textContent = state.themName || "Ù‡Ù…";
      el.usScore.textContent = us;
      el.themScore.textContent = them;



      const lead = Math.max(us, them);
      const prog = Math.min(100, Math.floor((lead/goal)*100)) || 0;
      el.progress.style.width = prog + "%";

      el.roundNo.textContent = state.round || 0;

      // Timer UI
      el.timerTxt.textContent = formatTime(state.timer.sec||0);
      el.startPauseBtn.textContent = state.timer.running ? "â¸" : "â–¶";

      // History
      el.count.textContent = state.entries.length;

      if(state.entries.length === 0){
        el.historyBody.className = "empty";
        el.historyBody.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬ÙˆÙ„Ø§Øª Ø¨Ø¹Ø¯";
      }else{
        el.historyBody.className = "list";
        el.historyBody.innerHTML = "";

        // reverse show
        state.entries.slice().reverse().forEach((e)=>{
          const name = e.team === "us" ? (state.usName||"Ù†Ø­Ù†") : (state.themName||"Ù‡Ù…");
          const modeTxt = e.mode === "san" ? "ØµÙ†" : e.mode === "hokm" ? "Ø­ÙƒÙ…" : "ÙŠØ¯ÙˆÙŠ";
          const timeTxt = e.timeSec != null ? formatTime(e.timeSec) : "â€”";

          const line = document.createElement("div");
          line.className = "rowItem";
          line.innerHTML = `
            <div>
              ${name}
              <span class="chip">${modeTxt}</span>
              <span class="chip">Ø¬ÙˆÙ„Ø© ${e.round}</span>
              <span class="chip">â± ${timeTxt}</span>
              <div style="margin-top:6px">
                <small>${escapeHtml(e.detail || "")}</small>
              </div>
            </div>
            <div><b>${e.totalPts||0}</b> <small>Ù†Ù‚Ø·Ø©</small></div>
          `;
          el.historyBody.appendChild(line);
        });
      }

      // Stats
      const adds = state.entries.length;
      const maxAdd = adds ? Math.max(...state.entries.map(e=>e.totalPts||0)) : 0;
      const avg = adds ? ((us+them)/adds) : 0;

      // Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹: Ù†Ø­Ø³Ø¨Ù‡Ø§ Ù…Ù† projPts > 0
      const projUs = state.entries.filter(e=>e.team==="us" && (e.projPts||0) > 0).length;
      const projThem = state.entries.filter(e=>e.team==="them" && (e.projPts||0) > 0).length;

      el.stUs.textContent = us;
      el.stThem.textContent = them;
      el.stAdds.textContent = adds;
      el.stMax.textContent = maxAdd;
      el.stAvg.textContent = Math.round(avg * 10) / 10;
      el.stRemain.textContent = Math.max(0, goal - Math.max(us, them));
      el.stUsProj.textContent = projUs;
      el.stThemProj.textContent = projThem;

      save();
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // -------------------- Tabs --------------------
    el.tabHistory.onclick = ()=>{
      el.tabHistory.classList.add("active");
      el.tabStats.classList.remove("active");
      el.historyBox.style.display = "";
      el.statsBox.style.display = "none";
    };
    el.tabStats.onclick = ()=>{
      el.tabStats.classList.add("active");
      el.tabHistory.classList.remove("active");
      el.historyBox.style.display = "none";
      el.statsBox.style.display = "";
    };

    // -------------------- Open modal --------------------
    el.addUs.onclick = ()=>openAddModal("us");
    el.addThem.onclick = ()=>openAddModal("them");

    // -------------------- Name edit --------------------
    document.addEventListener("click",(e)=>{
      const edit = e.target?.getAttribute?.("data-edit");
      if(!edit) return;
      const current = edit==="us" ? state.usName : state.themName;
      const name = prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚:", current || "");
      if(name == null) return;
      const v = name.trim();
      if(!v) return;
      if(edit==="us") state.usName = v; else state.themName = v;
      beep();
      render();
    });

    // -------------------- Undo / Clear / New --------------------
    el.undoBtn.onclick = ()=>{
      if(state.entries.length === 0) return;

      // Ù„Ø£Ù†Ù†Ø§ Ù†Ø¶ÙŠÙ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ø¯Ø®Ù„ÙŠÙ† (Ù†Ø­Ù† + Ù‡Ù…) Ù„ÙƒÙ„ Ø¬ÙˆÙ„Ø©ØŒ Ù†Ø­Ø°Ù Ø¢Ø®Ø± 2
      const lastRound = state.entries[state.entries.length-1].round;
      state.entries = state.entries.filter(x=>x.round !== lastRound);

      state.round = Math.max(0, (state.round||0) - 1);
      beep("undo");
      toast("â†© ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹");
      render();
    };

    el.clearBtn.onclick = ()=>{
      state.entries = [];
      state.round = 0;
      beep("clear");
      toast("ğŸ—‘ ØªÙ… Ø§Ù„Ù…Ø³Ø­");
      render();
    };

    el.newBtn.onclick = ()=>{
      state = structuredClone(defaultState);
      beep("clear");
      toast("â†º Ø¬Ø¯ÙŠØ¯");
      render();
    };

    // -------------------- Share --------------------
    el.shareBtn.onclick = async ()=>{
      const us = sumTeam("us");
      const them = sumTeam("them");
      const goal = state.goal || 152;

      const lines = [];
      lines.push(`Ø­Ø§Ø³Ø¨Ø© Ø¨Ù„ÙˆØª`);
      lines.push(`Ø§Ù„Ù‡Ø¯Ù: ${goal}`);
      lines.push(`${state.usName||"Ù†Ø­Ù†"}: ${us} | ${state.themName||"Ù‡Ù…"}: ${them}`);
      lines.push(`Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${state.entries.length}`);
      lines.push(`----------------`);

      // Ù†Ø¬Ù…Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª
      const rounds = [...new Set(state.entries.map(e=>e.round))];
      rounds.forEach(r=>{
        const items = state.entries.filter(e=>e.round===r);
        const usE = items.find(x=>x.team==="us");
        const themE = items.find(x=>x.team==="them");
        lines.push(`Ø¬ÙˆÙ„Ø© ${r} â€” ${usE?.detail || ""}`);
        lines.push(`  ${state.usName||"Ù†Ø­Ù†"}: ${usE?.totalPts||0} | ${state.themName||"Ù‡Ù…"}: ${themE?.totalPts||0} â± ${formatTime(usE?.timeSec||0)}`);
      });

      const text = lines.join("\n");
      try{
        if(navigator.share){ await navigator.share({ text }); return; }
      }catch{}
      try{
        await navigator.clipboard.writeText(text);
        toast("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®");
      }catch{
        const ta = document.createElement("textarea");
        ta.value = text; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy");
        document.body.removeChild(ta);
        toast("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®");
      }
    };

    // -------------------- Theme & Sound --------------------
    el.themeBtn.onclick = ()=>{
      state.theme = state.theme === "dark" ? "light" : "dark";
      beep();
      render();
    };
    el.soundBtn.onclick = ()=>{
      state.sound = !state.sound;
      toast(state.sound ? "ğŸ”Š Ø§Ù„ØµÙˆØª Ø´ØºØ§Ù„" : "ğŸ”‡ Ø§Ù„ØµÙˆØª Ù…ÙƒØªÙˆÙ…");
      render();
    };

    // -------------------- Timer controls --------------------
    el.startPauseBtn.onclick = ()=>{
      state.timer.running = !state.timer.running;
      ensureTimer();
      beep();
      render();
    };
    el.stopBtn.onclick = ()=>{
      state.timer.running = false;
      beep();
      render();
    };
    el.resetTimerBtn.onclick = ()=>{
      state.timer.sec = 0;
      state.timer.running = false;
      beep();
      render();
    };

    // Kickstart
    ensureTimer();
    render();
  </script>
</body>
</html>
