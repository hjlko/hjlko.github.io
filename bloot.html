<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Ø­Ø§Ø³Ø¨Ø© Ø¨Ù„ÙˆØª</title>
  <style>
    :root{
      --sand1:#fff7e6;
      --sand2:#f3e0b6;
      --card: rgba(255,255,255,.82);
      --card2: rgba(255,255,255,.62);
      --line: rgba(17,24,39,.10);
      --text: rgba(17,24,39,.92);
      --muted: rgba(17,24,39,.55);
      --gold:#c89b2d;
      --red:#ef4444;
      --green:#16a34a;
      --shadow: 0 12px 28px rgba(17,24,39,.12);
      --shadow2: 0 22px 70px rgba(17,24,39,.18);
      --r2:24px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Tahoma,Arial,sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(900px 520px at 50% -180px, rgba(200,155,45,.32), transparent 60%),
        radial-gradient(700px 360px at 14% 18%, rgba(230,200,111,.34), transparent 55%),
        linear-gradient(180deg,var(--sand1),var(--sand2));
    }
    .app{max-width:520px;margin:0 auto;padding:14px 14px calc(18px + env(safe-area-inset-bottom));}

    .header{
      position: sticky; top:0; z-index:10;
      padding-top: env(safe-area-inset-top);
      padding-bottom: 10px;
      background: linear-gradient(180deg, rgba(255,247,230,.96), rgba(255,247,230,.75), transparent);
      backdrop-filter: blur(10px);
    }
    .hRow{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .brand{display:flex;align-items:center;gap:10px;min-width:0;}
    .logo{
      width:42px;height:42px;border-radius:14px;border:1px solid var(--line);
      background:var(--card);box-shadow:var(--shadow);overflow:hidden;display:grid;place-items:center
    }
    .logo img{width:100%;height:100%;object-fit:cover;display:block}
    .bTxt{min-width:0;line-height:1.1}
    .bTxt b{display:block;font-weight:1100;font-size:15px;color:var(--gold);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .bTxt small{display:block;margin-top:3px;color:var(--muted);font-weight:900;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .hBtns{display:flex;gap:10px}
    .iconBtn,.dangerBtn{
      border-radius:16px;border:1px solid var(--line);background: var(--card);box-shadow: var(--shadow);
      cursor:pointer;user-select:none;font-weight:1100;
    }
    .iconBtn{width:42px;height:42px;display:grid;place-items:center}
    .dangerBtn{padding: 11px 12px;border-color: rgba(239,68,68,.25);background: rgba(239,68,68,.10);color: var(--red);}
    .iconBtn:active,.dangerBtn:active{transform:scale(.98)}

    .timerCard{
      margin-top:10px;border:1px solid var(--line);
      background: linear-gradient(180deg, var(--card), var(--card2));
      border-radius: var(--r2);box-shadow: var(--shadow);
      padding: 12px;display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .tTime{
      font-size:28px;font-weight:1200;letter-spacing:1px;
      padding: 8px 14px;border-radius: 16px;border:1px solid var(--line);
      background: rgba(255,255,255,.78);min-width: 120px;text-align:center;
    }
    .tGroup{display:flex;gap:10px}
    .tBtn{
      width:44px;height:44px;border-radius:16px;border:1px solid var(--line);
      background: rgba(255,255,255,.86);box-shadow: 0 12px 24px rgba(17,24,39,.10);
      cursor:pointer;user-select:none;display:grid;place-items:center;font-weight:1200;
    }
    .tBtn:active{transform:scale(.98)}
    .tBtn.green{color:var(--green)}
    .tBtn.red{color:var(--red)}

    .board{
      margin-top:12px;border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.80), rgba(255,255,255,.62));
      border-radius: var(--r2);box-shadow: var(--shadow2);padding: 12px;
    }
    .meta{display:flex;align-items:center;justify-content:space-between;gap:10px;color:var(--muted);font-weight:1100;font-size:13px;}
    .meta b{color:var(--gold)}
    .bar{margin-top:10px;height:12px;border-radius:999px;background:rgba(17,24,39,.06);border:1px solid var(--line);overflow:hidden;}
    .bar i{display:block;height:100%;width:0%;background:linear-gradient(90deg, rgba(230,200,111,.95), rgba(200,155,45,.95));border-radius:999px;transition:width .2s ease;}

    .teams{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .team{
      border:1px solid var(--line);background: rgba(255,255,255,.82);
      border-radius: var(--r2);box-shadow: var(--shadow2);
      padding: 12px;display:flex;flex-direction:column;gap:10px;min-height: 240px;
    }
    .teamTop{display:flex;align-items:center;justify-content:space-between;gap:10px;font-weight:1100;}
    .name span{font-size:15px;font-weight:1100}
    .edit{
      width:36px;height:36px;border-radius:14px;border:1px solid var(--line);
      background: rgba(255,255,255,.78);display:grid;place-items:center;cursor:pointer;user-select:none;font-weight:1200;opacity:.85;
    }
    .score{text-align:center;font-size:78px;font-weight:1300;line-height:1;margin: 0;letter-spacing:1px;}
    .team.red .score,.team.red .name span{color:var(--red)}
    .team.green .score,.team.green .name span{color:var(--green)}
    .addBig{
      margin-top:auto;width:100%;padding: 14px 12px;border-radius: 18px;border:1px solid var(--line);
      background: rgba(255,255,255,.92);box-shadow: 0 14px 30px rgba(17,24,39,.12);
      cursor:pointer;user-select:none;font-weight:1300;font-size:16px;
    }
    .addBig:active{transform:scale(.99)}

    /* Tabs + Boxes (Ø§Ù„Ø³Ø¬Ù„/Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª) */
    .tabs{
      margin-top: 12px;border:1px solid var(--line);background: var(--card);
      box-shadow: var(--shadow);border-radius: var(--r2);padding: 8px;display:flex;gap:10px;
    }
    .tab{
      flex:1;padding: 11px 12px;border-radius: 16px;border:1px solid transparent;background: transparent;
      font-weight:1200;color: var(--muted);cursor:pointer;user-select:none;
    }
    .tab.active{
      background: rgba(255,255,255,.90);border-color: var(--line);color: var(--text);
      box-shadow: 0 12px 22px rgba(17,24,39,.10);
    }

    .box{
      margin-top: 12px;border:1px solid var(--line);background: var(--card);
      box-shadow: var(--shadow2);border-radius: var(--r2);padding: 14px;
    }
    .boxHead{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;font-weight:1200;}
    .miniBtns{display:flex;gap:8px;flex-wrap:wrap}
    .mini{
      padding: 10px 12px;border-radius: 16px;border:1px solid var(--line);background: rgba(255,255,255,.86);
      box-shadow: 0 12px 22px rgba(17,24,39,.10);cursor:pointer;user-select:none;font-weight:1200;font-size:13px;
    }
    .mini:active{transform:scale(.98)}
    .mini.danger{border-color: rgba(239,68,68,.25);background: rgba(239,68,68,.10);color: var(--red);}

    .empty{padding:26px 10px;text-align:center;color:var(--muted);font-weight:1200}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .row{
      border:1px solid var(--line);background: rgba(255,255,255,.86);border-radius: 18px;padding: 12px;
      display:grid;grid-template-columns: 1fr auto;gap:10px;align-items:center;font-weight:1200;
    }
    .row small{color:var(--muted);font-weight:1100}

    .statsList{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .srow{
      border:1px solid var(--line);background: rgba(255,255,255,.86);border-radius: 18px;padding: 12px;
      display:flex;justify-content:space-between;align-items:center;font-weight:1200;
    }

    /* Bottom Sheet */
    .backdrop{position:fixed; inset:0;display:none;align-items:flex-end; justify-content:center;background: rgba(17,24,39,.36);z-index: 50;}
    .sheet{
      width:100%;max-width:520px;border-radius: 26px 26px 0 0;background: #fffaf0;border:1px solid var(--line);
      box-shadow: 0 -22px 80px rgba(17,24,39,.26);max-height: 90vh;overflow:auto;padding-bottom: env(safe-area-inset-bottom);
    }
    .sHead{position:sticky;top:0;background:#fff4d7;border-bottom:1px solid var(--line);padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .sTitle{font-weight:1300;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .close{width:44px;height:44px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.90);display:grid;place-items:center;cursor:pointer;user-select:none;font-weight:1200;}
    .sBody{padding:14px;display:flex;flex-direction:column;gap:12px;}
    label{display:block;font-size:12px;color:var(--muted);font-weight:1200;margin:0 0 6px;}
    input{
      width:100%;padding:12px;border-radius:18px;border:1px solid var(--line);
      background:rgba(255,255,255,.92);font-weight:1300;font-size:15px;outline:none;
    }
    .seg{display:flex;gap:8px;padding:6px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.86);}
    .seg button{
      flex:1;border-radius:999px;border:1px solid transparent;background:transparent;padding:11px 10px;
      cursor:pointer;user-select:none;font-weight:1300;color:var(--muted);
    }
    .seg button.active{background:#fff4d7;border-color:rgba(200,155,45,.22);color:var(--text);box-shadow:0 10px 18px rgba(17,24,39,.08);}
    .hint{color:var(--muted);font-weight:1100;font-size:12px;line-height:1.5;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}

    /* Projects */
    .projBox{
      border:1px solid var(--line);border-radius:18px;background:rgba(255,255,255,.86);
      padding:10px;box-shadow: 0 12px 22px rgba(17,24,39,.06);
    }
    .projTitle{display:flex;align-items:center;justify-content:space-between;gap:8px;font-weight:1300;color:rgba(17,24,39,.82);margin-bottom:8px}
    .projTitle span:last-child{color:var(--muted);font-weight:1200;font-size:12px}
    .projList{
      display:flex;flex-direction:column;gap:8px;
      max-height: 210px; overflow:auto; -webkit-overflow-scrolling: touch;
    }
    .projRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:7px 8px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.82);
    }
    .projRow b{font-size:14px;font-weight:1300}
    .projRow em{font-style:normal;color:var(--muted);font-weight:1200;font-size:12px}
    .ctr{display:flex;align-items:center;gap:8px}
    .ctr button{
      width:30px;height:30px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.90);cursor:pointer;user-select:none;font-weight:1400;font-size:16px;
    }
    .ctr button:active{transform:scale(.98)}
    .ctr span{min-width:22px;text-align:center;font-weight:1400;color:rgba(17,24,39,.85);font-size:14px}

    .details{
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,.86);
      box-shadow: 0 12px 22px rgba(17,24,39,.06);
      overflow:hidden;
    }
    .dHead{
      padding: 10px 12px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid var(--line);
      font-weight:1300;color: rgba(17,24,39,.80);
      background: rgba(255,244,215,.75);
    }
    .dGrid{display:grid;grid-template-columns:1fr;gap:10px;padding:10px;}
    .dCard{
      border-radius: 16px;border:1px solid var(--line);
      padding: 10px;background: rgba(255,255,255,.82);
    }
    .dCard.us{background: rgba(22,163,74,.10); border-color: rgba(22,163,74,.20);}
    .dCard.them{background: rgba(239,68,68,.08); border-color: rgba(239,68,68,.18);}
    .dTop{display:flex;align-items:center;justify-content:space-between;font-weight:1400}
    .dLines{margin-top:8px;display:flex;flex-direction:column;gap:6px}
    .line{display:flex;align-items:center;justify-content:space-between;gap:10px;color: rgba(17,24,39,.80);font-weight:1200;}
    .line code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(17,24,39,.06);
      padding: 2px 8px;border-radius: 10px;border:1px solid var(--line);
      direction:ltr;
    }
    .sum{margin-top:8px;display:flex;align-items:center;justify-content:space-between;font-weight:1500;font-size: 16px;}

    .sActions{padding:0 14px 14px;display:flex;gap:10px;}
    .sActions button{
      flex:1;padding:14px 12px;border-radius:18px;border:1px solid var(--line);
      background:rgba(255,255,255,.92);box-shadow:0 14px 24px rgba(17,24,39,.10);
      cursor:pointer; user-select:none;font-weight:1300;
    }
    .primary{background: linear-gradient(180deg, rgba(255,244,215,1), rgba(255,255,255,.92));border-color: rgba(200,155,45,.25);}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: 18px;padding:10px 12px;border-radius:999px;background:#111827;color:#fff;
      box-shadow: 0 18px 55px rgba(0,0,0,.25);font-weight:1300;opacity:0;pointer-events:none;
      transition: opacity .18s ease;z-index: 90;max-width: calc(100vw - 24px);text-align:center;
    }

        @media (max-width: 420px){
      .projBox{ padding:8px; border-radius:16px; }
      .projTitle{ margin-bottom:6px; font-size:13px; }
      .projTitle span:last-child{ font-size:11px; }
  #calcBack .sheet{
    max-width: 360px;
  }
  .cbtn{
    padding: 10px 6px;
    font-size: 15px;
  }
  .calcGrid{
    gap: 7px;
  }
      .projRow{ padding:6px 7px; border-radius:12px; gap:8px; }
      .projRow b{ font-size:12px; }
      .projRow em{ font-size:11px; }

      .ctr{ gap:6px; }
      .ctr button{ width:26px; height:26px; border-radius:10px; font-size:14px; }
      .ctr span{ min-width:18px; font-size:12px; }

      .projList{ max-height:150px; }
      }
    .toast.show{opacity:1}

    /* âœ… Calculator */
.calcGrid{
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:10px;
}

.cbtn{
  padding:14px 10px;
  border-radius:16px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.92);
  box-shadow: 0 14px 24px rgba(17,24,39,.10);
  cursor:pointer;
  user-select:none;
  font-weight:1400;
  font-size:18px;
}
.cbtn:active{transform:scale(.98)}
.cbtn.op{background: rgba(255,244,215,.85)}
.cbtn.danger{background: rgba(239,68,68,.10); color: var(--red); border-color: rgba(239,68,68,.25)}
/* âœ… Ø®Ù„ÙŠ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø£Ø¨Ù†Ø§Ø· Ù‚Ø¯Ù‘Ø§Ù… Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØªÙŠØ¬Ø© */
#calcBack{
  z-index: 9999 !important;
}
#calcBack .sheet{
  z-index: 10000 !important;
}
#calcBack .sheet{
  max-width: 420px;     /* ÙƒØ§Ù† 520 */
  border-radius: 22px 22px 0 0;
}
#calcBack .sBody{
  padding: 12px;
  gap: 10px;
}
#calcScreen{
  padding: 10px !important;
  border-radius: 14px !important;
  font-size: 16px !important;
}
.calcGrid{
  gap: 8px;
}

.cbtn{
  padding: 11px 8px;
  border-radius: 14px;
  font-size: 16px;
}
  </style>
</head>

<body>
  <div class="app">

    <div class="header">
      <div class="hRow">
        <div class="brand">
          <div class="logo" title="Ù„ÙˆØºÙˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"><img src="logo.png" alt="" onerror="this.style.display='none'"></div>
          <div class="bTxt">
            <b>Ø­Ø§Ø³Ø¨Ø© Ø¨Ù„ÙˆØª</b>
            <small>ÙŠÙ…ÙŠÙ†: Ù„Ù†Ø§ â€” ÙŠØ³Ø§Ø±: Ù„Ù‡Ù…</small>
          </div>
        </div>
        <div class="hBtns">
          <div class="iconBtn" id="soundBtn" title="ØµÙˆØª">ğŸ”Š</div>
          <button class="dangerBtn" id="newBtn">Ø¬Ø¯ÙŠØ¯ â†º</button>
        </div>
      </div>

      <div class="timerCard">
        <div class="tGroup">
          <div class="tBtn red" id="resetTimerBtn" title="ØªØµÙÙŠØ±">â†º</div>
          <div class="tBtn green" id="startPauseBtn" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù">â–¶</div>
        </div>
        <div class="tTime" id="timerTxt">00:00</div>
        <div class="tGroup">
          <div class="tBtn" id="stopBtn" title="Ø¥ÙŠÙ‚Ø§Ù">â±</div>
        </div>
      </div>

      <div class="board">
        <div class="meta">
          <span>Ø§Ù„Ø¬ÙˆÙ„Ø© <b id="roundNo">0</b></span>
          <span>Ø§Ù„Ù‡Ø¯Ù <b id="goalTxt">152</b></span>
        </div>
        <div class="bar"><i id="barFill"></i></div>
      </div>
    </div>

    <div class="teams">
      <div class="team green">
        <div class="teamTop">
          <div class="name"><span id="usName">Ù„Ù†Ø§</span></div>
          <div class="edit" data-edit="us" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…">âœ</div>
        </div>
        <div class="score" id="usScore">0</div>
        <button class="addBig" id="addUs">Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø© +</button>
      </div>

      <!-- âœ… Calculator Popup -->
<div class="backdrop" id="calcBack">
  <div class="sheet" style="max-height:75vh;">
    <div class="sHead">
      <div class="sTitle">ğŸ§® Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø£Ø¨Ù†Ø§Ø·</div>
      <div class="close" id="calcClose">âœ•</div>
    </div>

    <div class="sBody">
      <div style="display:flex;gap:10px;align-items:center;">
        <input id="calcScreen" readonly style="font-size:18px;text-align:left;direction:ltr;">
      </div>

      <div class="hint">Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ¨Ø¹Ø¯ÙŠÙ† Ø§Ø¶ØºØ· =</div>

      <div class="calcGrid">
        <button class="cbtn" data-c="7">7</button>
        <button class="cbtn" data-c="8">8</button>
        <button class="cbtn" data-c="9">9</button>
        <button class="cbtn op" data-c="/">Ã·</button>

        <button class="cbtn" data-c="4">4</button>
        <button class="cbtn" data-c="5">5</button>
        <button class="cbtn" data-c="6">6</button>
        <button class="cbtn op" data-c="*">Ã—</button>

        <button class="cbtn" data-c="1">1</button>
        <button class="cbtn" data-c="2">2</button>
        <button class="cbtn" data-c="3">3</button>
        <button class="cbtn op" data-c="-">âˆ’</button>

        <button class="cbtn danger" id="calcClear">C</button>
        <button class="cbtn" data-c="0">0</button>
        <button class="cbtn" data-c=".">.</button>
        <button class="cbtn op" data-c="+">+</button>

        <button class="cbtn" style="grid-column: span 2;" id="calcBackspace">âŒ«</button>
        <button class="cbtn primary" style="grid-column: span 2;" id="calcEq">=</button>
      </div>

      <div class="hint">
        âœ… Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ­Ø³Ø¨ØŒ Ø§Ù„Ù†Ø§ØªØ¬ ÙŠÙ†Ø­Ø· Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø£Ø¨Ù†Ø§Ø·.
      </div>
    </div>
  </div>
</div>


      <div class="team red">
        <div class="teamTop">
          <div class="name"><span id="themName">Ù„Ù‡Ù…</span></div>
          <div class="edit" data-edit="them" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…">âœ</div>
        </div>
        <div class="score" id="themScore">0</div>
        <button class="addBig" id="addThem">Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø© +</button>
      </div>
    </div>

    <!-- âœ… Ø±Ø¬Ù‘Ø¹Ù†Ø§ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <div class="tabs">
      <button class="tab active" id="tabHistory">â†© Ø§Ù„Ø³Ø¬Ù„</button>
      <button class="tab" id="tabStats">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
    </div>

    <!-- âœ… Ø±Ø¬Ù‘Ø¹Ù†Ø§ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø³Ø¬Ù„ -->
    <div class="box" id="historyBox">
      <div class="boxHead">
        <div>Ø§Ù„Ø³Ø¬Ù„ (<span id="count">0</span>)</div>
        <div class="miniBtns">
          <button class="mini" id="undoBtn">â†© ØªØ±Ø§Ø¬Ø¹</button>
          <button class="mini" id="shareBtn">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</button>
          <button class="mini danger" id="clearBtn">ğŸ—‘ Ù…Ø³Ø­</button>
        </div>
      </div>
      <div id="historyBody" class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„</div>
    </div>

    <!-- âœ… Ø±Ø¬Ù‘Ø¹Ù†Ø§ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="box" id="statsBox" style="display:none;">
      <div class="boxHead"><div>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div></div>
      <div class="statsList">
        <div class="srow"><div>Ù…Ø¬Ù…ÙˆØ¹ Ù„Ù†Ø§</div><div><b id="stUs">0</b></div></div>
        <div class="srow"><div>Ù…Ø¬Ù…ÙˆØ¹ Ù„Ù‡Ù…</div>/div><div><b id="stThem">0</b></div></div>
        <div class="srow"><div>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div><div><b id="stAdds">0</b></div></div>
        <div class="srow"><div>Ø£Ø¹Ù„Ù‰ Ø³Ø¬Ù„</div><div><b id="stMax">0</b></div></div>
      </div>
    </div>

  </div>

  <div class="toast" id="toast">âœ… ØªÙ…</div>

  <!-- Bottom Sheet -->
  <div class="backdrop" id="modalBack">
    <div class="sheet">
      <div class="sHead">
        <div class="sTitle" id="mTitle">Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø©</div>
        <div class="close" id="mClose">âœ•</div>
      </div>

      <div class="sBody">
        <div>
          <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</label>
          <div class="seg">
            <button id="mManual" class="active">ÙŠØ¯ÙˆÙŠ</button>
            <button id="mAdv">Ù…ØªÙ‚Ø¯Ù…</button>
          </div>
        </div>

        <!-- Manual -->
        <div id="boxManual">
          <div class="grid2">
            <div>
              <label id="labA">Ù†Ù‚Ø§Ø· Ø§Ù„ÙØ±ÙŠÙ‚</label>
              <input id="inA" type="number" min="0" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 30">
            </div>
            <div>
              <label id="labB">Ù†Ù‚Ø§Ø· Ø§Ù„Ø®ØµÙ…</label>
              <input id="inB" type="number" min="0" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 20">
            </div>
          </div>
          <div class="hint" style="margin-top:8px">ÙŠØ¯ÙˆÙŠ = Ù†Ù‚Ø§Ø· Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø³ÙŠÙ….</div>
        </div>

        <!-- Advanced -->
        <div id="boxAdv" style="display:none;">
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„Ù„Ø¹Ø¨Ø©</label>
            <div class="seg">
              <button id="modeSan" class="active">ØµÙ† (120)</button>
              <button id="modeHokm">Ø­ÙƒÙ… (150)</button>
            </div>
          </div>

          <div>
            <label id="roleLbl">Ù…ÙŠÙ† ØµÙ†ØŸ</label>
            <div class="seg">
              <button id="roleA" class="active">Ø§Ù„ÙØ±ÙŠÙ‚</button>
              <button id="roleB">Ø§Ù„Ø®ØµÙ…</button>
            </div>
            <div class="hint" id="roleHint">Ø¥Ø°Ø§ Ø®Ø³Ø± Ø§Ù„ØµÙ†: Ø§Ù„ØµÙ† 0 â€” Ø§Ù„Ø£Ø±Ø¶ Ù„Ù„Ø®ØµÙ… â€” Ø§Ù„Ø®ØµÙ… +24 + Ù…Ø´Ø§Ø±ÙŠØ¹Ù‡</div>
          </div>

          <div>
            <label id="labAbnat">Ø£Ø¨Ù†Ø§Ø· Ø§Ù„ÙØ±ÙŠÙ‚</label>
            <input id="inAbnat" type="number" min="0" inputmode="numeric" placeholder="Ø§ÙƒØªØ¨ Ø£Ø¨Ù†Ø§Ø· Ø§Ù„ÙØ±ÙŠÙ‚">
            <div class="hint" id="hintCalc">ØµÙ†: Ã·5 â€” Ø­ÙƒÙ…: Ã·10 (ØªÙ‚Ø±ÙŠØ¨ 10.60 âœ 11)</div>
          </div>

          <div class="grid2">
            <div class="projBox">
              <div class="projTitle">
                <span id="projTitleA">Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ÙØ±ÙŠÙ‚</span>
                <span id="projSumA">0 Ù†Ù‚Ø·Ø©</span>
              </div>
              <div class="projList" id="projListA"></div>
            </div>

            <div class="projBox">
              <div class="projTitle">
                <span id="projTitleB">Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø®ØµÙ…</span>
                <span id="projSumB">0 Ù†Ù‚Ø·Ø©</span>
              </div>
              <div class="projList" id="projListB"></div>
            </div>
          </div>

          <div>
            <label>Ø§Ù„Ø£Ø±Ø¶</label>
            <div class="seg">
              <button id="ardA" class="active">Ù„Ù„ÙØ±ÙŠÙ‚</button>
              <button id="ardB">Ù„Ù„Ø®ØµÙ…</button>
            </div>
            <div class="hint">Ø§Ù„Ø£Ø±Ø¶: ØµÙ† +2 â€” Ø­ÙƒÙ… +1 (ÙˆØ¹Ù†Ø¯ Ø®Ø³Ø§Ø±Ø© Ø§Ù„ØµÙ†/Ø§Ù„Ø­ÙƒÙ…: Ø§Ù„Ø£Ø±Ø¶ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù„Ø®ØµÙ…)</div>
          </div>

          <div class="details">
            <div class="dHead">
              <span>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</span>
              <span style="color:var(--muted);font-weight:1200;font-size:12px">âœ…</span>
            </div>
            <div class="dGrid">
              <div class="dCard us" id="cardA"></div>
              <div class="dCard them" id="cardB"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="sActions">
        <button id="mClear">Ù…Ø³Ø­</button>
        <button class="primary" id="mAdd">Ø¥Ø¶Ø§ÙØ©</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const LS = "baloot_final_v1";
  const $ = (id)=>document.getElementById(id);

  const el = {
    // top
    roundNo: $("roundNo"), goalTxt: $("goalTxt"), barFill: $("barFill"),
    usName: $("usName"), themName: $("themName"),
    usScore: $("usScore"), themScore: $("themScore"),
    timerTxt: $("timerTxt"),
    startPauseBtn: $("startPauseBtn"), stopBtn: $("stopBtn"), resetTimerBtn: $("resetTimerBtn"),
    addUs: $("addUs"), addThem: $("addThem"),
    soundBtn: $("soundBtn"), newBtn: $("newBtn"),
    toast: $("toast"),

    // tabs + history/stats
    tabHistory: $("tabHistory"), tabStats: $("tabStats"),
    historyBox: $("historyBox"), statsBox: $("statsBox"),
    historyBody: $("historyBody"), count: $("count"),
    undoBtn: $("undoBtn"), clearBtn: $("clearBtn"), shareBtn: $("shareBtn"),
    stUs: $("stUs"), stThem: $("stThem"), stAdds: $("stAdds"), stMax: $("stMax"),

    // modal
    modalBack: $("modalBack"), mTitle: $("mTitle"), mClose: $("mClose"),
    mManual: $("mManual"), mAdv: $("mAdv"),
    boxManual: $("boxManual"), boxAdv: $("boxAdv"),
    labA: $("labA"), labB: $("labB"),
    inA: $("inA"), inB: $("inB"),
    modeSan: $("modeSan"), modeHokm: $("modeHokm"),
    roleLbl: $("roleLbl"), roleHint: $("roleHint"),
    roleA: $("roleA"), roleB: $("roleB"),
    labAbnat: $("labAbnat"), inAbnat: $("inAbnat"), hintCalc: $("hintCalc"),
    projTitleA: $("projTitleA"), projTitleB: $("projTitleB"),
    projListA: $("projListA"), projListB: $("projListB"),
    projSumA: $("projSumA"), projSumB: $("projSumB"),
    ardA: $("ardA"), ardB: $("ardB"),
    cardA: $("cardA"), cardB: $("cardB"),
    mAdd: $("mAdd"), mClear: $("mClear"),
  };

  const defaultState = {
    goal: 152,
    usName: "Ù„Ù†Ø§",
    themName: "Ù„Ù‡Ù…",
    round: 0,
    entries: [], // {round,timeSec,usPts,themPts,note}
    timer: { sec:0, running:false },
    sound: true,
    voice: true
  };

  function load(){
    try{
      const raw = localStorage.getItem(LS);
      if(!raw) return structuredClone(defaultState);
      const s = JSON.parse(raw);
      if(!s || typeof s!=="object") return structuredClone(defaultState);
      if(typeof s.goal!=="number") s.goal=152;
      if(typeof s.usName!=="string") s.usName="Ù„Ù†Ø§";
      if(typeof s.themName!=="string") s.themName="Ù„Ù‡Ù…";
      if(typeof s.round!=="number") s.round=0;
      if(!Array.isArray(s.entries)) s.entries=[];
      if(!s.timer) s.timer={sec:0,running:false};
      if(typeof s.timer.sec!=="number") s.timer.sec=0;
      if(typeof s.timer.running!=="boolean") s.timer.running=false;
      if(typeof s.sound!=="boolean") s.sound=true;
      if(typeof s.voice!=="boolean") s.voice=true;
      return s;
    }catch{ return structuredClone(defaultState); }
  }

  let state = load();
  let saveT=null;
  function saveSoon(){
    if(saveT) return;
    saveT=setTimeout(()=>{
      saveT=null;
      localStorage.setItem(LS, JSON.stringify(state));
    }, 350);
  }

  function fmt(sec){
    sec = Math.max(0, sec|0);
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }

  function sum(){
    let us=0, them=0;
    for(const e of state.entries){ us += (e.usPts||0); them += (e.themPts||0); }
    return {us, them};
  }

  function toast(msg){
    el.toast.textContent = msg;
    el.toast.classList.add("show");
    setTimeout(()=>el.toast.classList.remove("show"), 950);
  }

  // âœ… Ø§Ù„ØªÙ‚Ø±ÙŠØ¨: 10.60 ÙŠØ·Ù„Ø¹ 11 â€” 10.50 ÙŠÙ†Ø²Ù„ 10
  function abnatRound(x){
    const f = Math.floor(x);
    const frac2 = Math.round((x - f) * 100);
    return (frac2 >= 60) ? (f + 1) : f;
  }

  // ---------- Sound ----------
  let audioCtx=null;
  function sfx(type="tap"){
    if(!state.sound) return;
    try{
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const o=audioCtx.createOscillator();
      const g=audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      const now=audioCtx.currentTime;
      const f = type==="add" ? 760 : type==="undo" ? 520 : type==="clear" ? 260 : 560;
      o.type="sine";
      o.frequency.setValueAtTime(f, now);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.10, now+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.12);
      o.start(now); o.stop(now+0.14);
    }catch{}
  }

  // ---------- Voice ----------
  function speak(text){
    if(!state.voice) return;
    try{
      if(!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "ar-SA";
      u.rate = 1.02;
      window.speechSynthesis.speak(u);
    }catch{}
  }

  function renderHistoryAndStats(){
    el.count.textContent = state.entries.length;

    if(state.entries.length===0){
      el.historyBody.className="empty";
      el.historyBody.textContent="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„";
    }else{
      el.historyBody.className="list";
      el.historyBody.innerHTML="";
      const slice = state.entries.slice(-30).reverse();
      for(const e of slice){
        const row=document.createElement("div");
        row.className="row";
        row.innerHTML = `
          <div>
            <div><small>â± ${fmt(e.timeSec||0)} â€” Ø¬ÙˆÙ„Ø© ${e.round}</small></div>
            <div><small>${e.note||""}</small></div>
          </div>
          <div style="text-align:left">
            <div><b>${state.usName}: ${e.usPts||0}</b></div>
            <div><b>${state.themName}: ${e.themPts||0}</b></div>
          </div>
        `;
        el.historyBody.appendChild(row);
      }
    }

    const {us, them} = sum();
    el.stUs.textContent = us;
    el.stThem.textContent = them;
    el.stAdds.textContent = state.entries.length;
    let mx=0; for(const e of state.entries) mx = Math.max(mx, e.usPts||0, e.themPts||0);
    el.stMax.textContent = mx;
  }

  function render(){
    el.goalTxt.textContent = state.goal;
    el.roundNo.textContent = state.round;
    el.usName.textContent = state.usName;
    el.themName.textContent = state.themName;

    const {us, them} = sum();
    el.usScore.textContent = us;
    el.themScore.textContent = them;

    const lead = Math.max(us, them);
    const prog = Math.min(100, Math.floor((lead / state.goal) * 100)) || 0;
    el.barFill.style.width = prog + "%";

    el.timerTxt.textContent = fmt(state.timer.sec||0);
    el.startPauseBtn.textContent = state.timer.running ? "â¸" : "â–¶";
    el.soundBtn.textContent = state.sound ? "ğŸ”Š" : "ğŸ”‡";

    renderHistoryAndStats();
    saveSoon();
  }

  // ---------- Timer ----------
  setInterval(()=>{
    if(!state.timer.running) return;
    state.timer.sec = (state.timer.sec||0) + 1;
    el.timerTxt.textContent = fmt(state.timer.sec||0);
    saveSoon();
  }, 1000);

  // ---------- Modal State ----------
  let modalTeam = "us";
  let inputMode = "manual";
  let advMode = "san";
  let roleSide = "A";
  let ardTo = "A";
  let projCountsA = {};
  let projCountsB = {};

  const projSan = [
    {key:"sra", label:"Ø³Ø±Ø§", pts:4},
    {key:"50",  label:"Ø®Ù…Ø³ÙŠÙ†", pts:10},
    {key:"100", label:"Ù…ÙŠØ©", pts:20},
    {key:"400", label:"400", pts:40},
  ];
  const projHokm = [
    {key:"sra", label:"Ø³Ø±Ø§", pts:2},
    {key:"50",  label:"Ø®Ù…Ø³ÙŠÙ†", pts:5},
    {key:"100", label:"Ù…ÙŠØ©", pts:10},
    {key:"baloot", label:"Ø¨Ù„ÙˆØª", pts:2},
  ];

  function namesForModal(){
    const teamName = (modalTeam==="us") ? state.usName : state.themName;
    const oppName  = (modalTeam==="us") ? state.themName : state.usName;
    return {teamName, oppName};
  }

  function setInputMode(m){
    inputMode = m;
    el.mManual.classList.toggle("active", m==="manual");
    el.mAdv.classList.toggle("active", m==="adv");
    el.boxManual.style.display = m==="manual" ? "" : "none";
    el.boxAdv.style.display = m==="adv" ? "" : "none";
  }

  function listProjects(){
    return advMode==="hokm" ? projHokm : projSan;
  }
  function modeTotals(){
    return advMode==="hokm"
      ? {totalAb:150, div:10, ard:1, bonus:15}
      : {totalAb:120, div:5,  ard:2, bonus:24};
  }

  function setAdvMode(m){
    advMode = m;
    el.modeSan.classList.toggle("active", m==="san");
    el.modeHokm.classList.toggle("active", m==="hokm");

    if(advMode==="san"){
      el.roleLbl.textContent = "Ù…ÙŠÙ† ØµÙ†ØŸ";
      el.roleHint.textContent = "Ø¥Ø°Ø§ Ø®Ø³Ø± Ø§Ù„ØµÙ†: Ø§Ù„ØµÙ† 0 â€” Ø§Ù„Ø£Ø±Ø¶ Ù„Ù„Ø®ØµÙ… â€” Ø§Ù„Ø®ØµÙ… +24 + Ù…Ø´Ø§Ø±ÙŠØ¹Ù‡";
      el.hintCalc.textContent = "ØµÙ†: Ã·5 (ØªÙ‚Ø±ÙŠØ¨ 10.60 âœ 11)";
    }else{
      el.roleLbl.textContent = "Ù…ÙŠÙ† Ø­ÙƒÙ…ØŸ";
      el.roleHint.textContent = "Ø¥Ø°Ø§ Ø®Ø³Ø± Ø§Ù„Ø­ÙƒÙ…: Ø§Ù„Ø­ÙƒÙ… 0 â€” Ø§Ù„Ø£Ø±Ø¶ Ù„Ù„Ø®ØµÙ… â€” Ø§Ù„Ø®ØµÙ… +15 + Ù…Ø´Ø§Ø±ÙŠØ¹Ù‡";
      el.hintCalc.textContent = "Ø­ÙƒÙ…: Ã·10 (ØªÙ‚Ø±ÙŠØ¨ 10.60 âœ 11)";
    }

    projCountsA = {};
    projCountsB = {};
    buildProjectsUI();
    updateDetails();
  }

  function setRole(side){
    roleSide = side;
    el.roleA.classList.toggle("active", side==="A");
    el.roleB.classList.toggle("active", side==="B");
    updateDetails();
  }

  function setArd(side){
    ardTo = side;
    el.ardA.classList.toggle("active", side==="A");
    el.ardB.classList.toggle("active", side==="B");
    updateDetails();
  }

  function projTotal(counts){
    let t=0;
    const list = listProjects();
    for(const p of list){
      const c = Math.max(0, counts[p.key]||0);
      t += c * p.pts;
    }
    return t;
  }

  function buildProjectsUI(){
    const {teamName, oppName} = namesForModal();
    el.projTitleA.textContent = `Ù…Ø´Ø§Ø±ÙŠØ¹ ${teamName}`;
    el.projTitleB.textContent = `Ù…Ø´Ø§Ø±ÙŠØ¹ ${oppName}`;

    const list = listProjects();
    el.projListA.innerHTML="";
    el.projListB.innerHTML="";

    function mkRow(p, side){
      const wrap=document.createElement("div");
      wrap.className="projRow";
      wrap.innerHTML = `
        <div><b>${p.label}</b> <em>(+${p.pts})</em></div>
        <div class="ctr">
          <button type="button" data-act="minus">âˆ’</button>
          <span data-count>0</span>
          <button type="button" data-act="plus">+</button>
        </div>
      `;
      const cntEl = wrap.querySelector("[data-count]");
      const btns = wrap.querySelectorAll("button");

      const getCounts = ()=> side==="A" ? projCountsA : projCountsB;
      const setCounts = (k,v)=> { if(side==="A") projCountsA[k]=v; else projCountsB[k]=v; };

      const sync = ()=>{
        const c = Math.max(0, getCounts()[p.key]||0);
        cntEl.textContent = c;
        el.projSumA.textContent = `${projTotal(projCountsA)} Ù†Ù‚Ø·Ø©`;
        el.projSumB.textContent = `${projTotal(projCountsB)} Ù†Ù‚Ø·Ø©`;
      };

      btns.forEach(b=>{
        b.addEventListener("click", ()=>{
          const act=b.getAttribute("data-act");
          const cur=Math.max(0, getCounts()[p.key]||0);
          const nxt = act==="plus" ? cur+1 : Math.max(0, cur-1);
          setCounts(p.key, nxt);
          sync();
          updateDetails();
          sfx("tap");
        });
      });

      sync();
      return wrap;
    }

    for(const p of list){
      el.projListA.appendChild(mkRow(p,"A"));
      el.projListB.appendChild(mkRow(p,"B"));
    }
    el.projSumA.textContent = `${projTotal(projCountsA)} Ù†Ù‚Ø·Ø©`;
    el.projSumB.textContent = `${projTotal(projCountsB)} Ù†Ù‚Ø·Ø©`;
  }

  // âœ… Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ù„Ù„ØµÙ†/Ø§Ù„Ø­ÙƒÙ… + Ù†Ù‚Ù„ Ø§Ù„Ø£Ø±Ø¶ + Ø­Ø°Ù Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø®Ø§Ø³Ø± (ØµÙ†/Ø­ÙƒÙ…)
  function computeAdvanced(){
    const {teamName, oppName} = namesForModal();
    const {totalAb, div, ard, bonus} = modeTotals();

    const v = parseFloat(el.inAbnat.value||"");
    const hasAb = el.inAbnat.value!=="" && !Number.isNaN(v);

    const yourAb = hasAb ? Math.max(0, v) : 0;
    const oppAb  = hasAb ? Math.max(0, totalAb - yourAb) : 0;

    const rawA = hasAb ? (yourAb / div) : 0;
    const rawB = hasAb ? (oppAb  / div) : 0;

    const abPtsA = hasAb ? abnatRound(rawA) : 0;
    const abPtsB = hasAb ? abnatRound(rawB) : 0;

    const projA_in = projTotal(projCountsA);
    const projB_in = projTotal(projCountsB);

    const hasSomething = hasAb || projA_in>0 || projB_in>0;
    const ardPts = hasSomething ? ard : 0;

    const ardA_in = (ardTo==="A") ? ardPts : 0;
    const ardB_in = (ardTo==="B") ? ardPts : 0;

    const preA = abPtsA + projA_in + ardA_in;
    const preB = abPtsB + projB_in + ardB_in;

    const roleOwner = roleSide;
    const otherSide = roleOwner==="A" ? "B" : "A";

    const roleOwnerPre = (roleOwner==="A") ? preA : preB;
    const otherPre     = (otherSide==="A") ? preA : preB;

    const isLose = otherPre > roleOwnerPre;

    let totalA = preA, totalB = preB;
    let projA = projA_in, projB = projB_in;
    let ardA = ardA_in, ardB = ardB_in;

    const roleTxt = (advMode==="san") ? "ØµÙ†" : "Ø­ÙƒÙ…";
    let roleNote = `${roleTxt} Ø·Ø¨ÙŠØ¹ÙŠ`;
    const roleOwnerName = (roleSide==="A") ? teamName : oppName;

    if(isLose){
      if(roleOwner==="A"){
        totalA = 0; projA = 0; ardA = 0;
        ardB  = ardPts;
        totalB = bonus + projB_in + ardB;
      }else{
        totalB = 0; projB = 0; ardB = 0;
        ardA  = ardPts;
        totalA = bonus + projA_in + ardA;
      }
      roleNote = `${roleTxt} Ø®Ø³Ø± â‡’ ${roleTxt} 0ØŒ Ø§Ù„Ø£Ø±Ø¶ Ù„Ù„Ø®ØµÙ…ØŒ Ø§Ù„Ø®ØµÙ… +${bonus} + Ù…Ø´Ø§Ø±ÙŠØ¹Ù‡`;
    }

    const usPts   = (modalTeam==="us") ? totalA : totalB;
    const themPts = (modalTeam==="us") ? totalB : totalA;

    return {
      teamName, oppName,
      totalAb, div,
      yourAb, oppAb,
      rawA, rawB,
      abPtsA, abPtsB,
      projA, projB,
      ardA, ardB,
      totalA, totalB,
      usPts, themPts,
      modeText: roleTxt,
      roleNote,
      isLose,
      bonus,
      roleOwnerName
    };
  }

  function updateDetails(){
    if(inputMode!=="adv"){
      el.cardA.innerHTML="";
      el.cardB.innerHTML="";
      return;
    }

    const r = computeAdvanced();

    el.cardA.innerHTML = `
      <div class="dTop"><div>${r.teamName}</div><div>${r.totalA}</div></div>
      <div class="dLines">
        <div class="line"><span>Ø§Ù„Ø£Ø¨Ù†Ø§Ø·</span><span><code>${r.yourAb} Ã· ${r.div} = ${r.rawA.toFixed(2)}</code> â†’ <b>${r.abPtsA}</b></span></div>
        <div class="line"><span>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</span><span><b>${r.projA}</b></span></div>
        <div class="line"><span>Ø§Ù„Ø£Ø±Ø¶</span><span><b>${r.ardA}</b></span></div>
        <div class="line"><span>${r.modeText}</span><span><b>${r.roleOwnerName}</b></span></div>
        <div class="line"><span>Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©</span><span><small>${r.roleNote}</small></span></div>
      </div>
      <div class="sum"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</span><span>${r.totalA}</span></div>
    `;

    el.cardB.innerHTML = `
      <div class="dTop"><div>${r.oppName}</div><div>${r.totalB}</div></div>
      <div class="dLines">
        <div class="line"><span>Ø§Ù„Ø£Ø¨Ù†Ø§Ø·</span><span><code>${r.oppAb} Ã· ${r.div} = ${r.rawB.toFixed(2)}</code> â†’ <b>${r.abPtsB}</b></span></div>
        <div class="line"><span>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</span><span><b>${r.projB}</b></span></div>
        <div class="line"><span>Ø§Ù„Ø£Ø±Ø¶</span><span><b>${r.ardB}</b></span></div>
      </div>
      <div class="sum"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</span><span>${r.totalB}</span></div>
    `;
  }

  function addEntry(usPts, themPts, note){
    state.round = (state.round||0) + 1;
    state.entries.push({
      round: state.round,
      timeSec: state.timer.sec||0,
      usPts, themPts,
      note: note||""
    });

    if(!state.timer.running){
      state.timer.running = true;
      el.startPauseBtn.textContent = "â¸";
    }

    sfx("add");
    toast("âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
    render();

    const totals = sum();
    speak(`Ø§Ù„Ù†Ø´Ø±Ø©: ${state.usName} ${totals.us} Ùˆ ${state.themName} ${totals.them}`);
  }

  function openModal(team){
    modalTeam = team;
    const {teamName, oppName} = namesForModal();

    el.mTitle.textContent = `Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø© â€” ${teamName}`;
    el.labA.textContent = `Ù†Ù‚Ø§Ø· ${teamName}`;
    el.labB.textContent = `Ù†Ù‚Ø§Ø· ${oppName}`;
    el.labAbnat.textContent = `Ø£Ø¨Ù†Ø§Ø· ${teamName}`;

    el.inA.value=""; el.inB.value="";
    el.inAbnat.value="";
    projCountsA = {}; projCountsB = {};
    ardTo="A"; roleSide="A";

    setInputMode("manual");
    setAdvMode("san");
    setArd("A");
    setRole("A");

    el.modalBack.style.display="flex";
    document.body.style.overflow="hidden";
    sfx("tap");
  }

  function closeModal(){
    el.modalBack.style.display="none";
    document.body.style.overflow="";
    sfx("tap");
  }

  // Tabs
  el.tabHistory.addEventListener("click", ()=>{
    el.tabHistory.classList.add("active");
    el.tabStats.classList.remove("active");
    el.historyBox.style.display="";
    el.statsBox.style.display="none";
    sfx("tap");
  });
  el.tabStats.addEventListener("click", ()=>{
    el.tabStats.classList.add("active");
    el.tabHistory.classList.remove("active");
    el.historyBox.style.display="none";
    el.statsBox.style.display="";
    sfx("tap");
  });

  // Events
  el.addUs.addEventListener("click", ()=>openModal("us"));
  el.addThem.addEventListener("click", ()=>openModal("them"));

  el.mClose.addEventListener("click", closeModal);
  el.modalBack.addEventListener("click",(e)=>{ if(e.target===el.modalBack) closeModal(); });

  el.mManual.addEventListener("click", ()=>{ setInputMode("manual"); sfx("tap"); });
  el.mAdv.addEventListener("click", ()=>{
    setInputMode("adv");
    buildProjectsUI();
    updateDetails();
    sfx("tap");
  });

  el.modeSan.addEventListener("click", ()=>{ setAdvMode("san"); sfx("tap"); });
  el.modeHokm.addEventListener("click", ()=>{ setAdvMode("hokm"); sfx("tap"); });

  el.roleA.addEventListener("click", ()=>{ setRole("A"); sfx("tap"); });
  el.roleB.addEventListener("click", ()=>{ setRole("B"); sfx("tap"); });

  el.ardA.addEventListener("click", ()=>{ setArd("A"); sfx("tap"); });
  el.ardB.addEventListener("click", ()=>{ setArd("B"); sfx("tap"); });

  el.inAbnat.addEventListener("input", ()=>{ updateDetails(); });

  el.mClear.addEventListener("click", ()=>{
    el.inA.value=""; el.inB.value="";
    el.inAbnat.value="";
    projCountsA = {}; projCountsB = {};
    buildProjectsUI();
    setArd("A");
    setRole("A");
    updateDetails();
    sfx("clear");
    toast("ğŸ§¹ ØªÙ…");
  });

  el.mAdd.addEventListener("click", ()=>{
    const {teamName, oppName} = namesForModal();

    if(inputMode==="manual"){
      const a = Math.max(0, parseInt(el.inA.value||"0",10) || 0);
      const b = Math.max(0, parseInt(el.inB.value||"0",10) || 0);
      if(a===0 && b===0){ toast("Ø§ÙƒØªØ¨ Ù†Ù‚Ø§Ø·"); return; }

      const usPts   = (modalTeam==="us") ? a : b;
      const themPts = (modalTeam==="us") ? b : a;

      addEntry(usPts, themPts, `ÙŠØ¯ÙˆÙŠ â€” ${teamName}:${a} | ${oppName}:${b}`);
      closeModal();
      return;
    }

    const r = computeAdvanced();
    const hasAny =
      (el.inAbnat.value!=="" && !Number.isNaN(parseFloat(el.inAbnat.value))) ||
      (projTotal(projCountsA)>0) || (projTotal(projCountsB)>0);

    if(!hasAny){
      toast("Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø¨Ù†Ø§Ø· Ø£Ùˆ Ø²ÙˆØ¯ Ù…Ø´Ø§Ø±ÙŠØ¹");
      return;
    }

    addEntry(r.usPts, r.themPts, `Ù…ØªÙ‚Ø¯Ù… (${r.modeText}) â€” ${r.roleNote}`);
    closeModal();
  });

  // Undo / Clear / Share
  el.undoBtn.addEventListener("click", ()=>{
    if(state.entries.length===0) return;
    state.entries.pop();
    state.round = Math.max(0, (state.round||0)-1);
    sfx("undo");
    toast("â†© ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹");
    render();
  });

  el.clearBtn.addEventListener("click", ()=>{
    state.entries=[];
    state.round=0;
    sfx("clear");
    toast("ğŸ—‘ ØªÙ… Ø§Ù„Ù…Ø³Ø­");
    render();
  });

  el.shareBtn.addEventListener("click", async ()=>{
    const {us, them} = sum();
    const lines = [];
    lines.push("Ø§Ù„Ù†Ø´Ø±Ø©");
    lines.push(`${state.usName}: ${us} | ${state.themName}: ${them}`);
    lines.push(`Ø³Ø¬Ù„Ø§Øª: ${state.entries.length}`);
    lines.push("â€” â€” â€”");
    for(const e of state.entries){
      lines.push(`Ø¬ÙˆÙ„Ø© ${e.round} â± ${fmt(e.timeSec||0)} | ${state.usName}:${e.usPts} ${state.themName}:${e.themPts} â€” ${e.note||""}`);
    }
    const text = lines.join("\n");
    try{ if(navigator.share){ await navigator.share({text}); return; } }catch{}
    try{ await navigator.clipboard.writeText(text); toast("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®"); }catch{ toast("Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§"); }
  });

  // Timer
  el.startPauseBtn.addEventListener("click", ()=>{
    state.timer.running = !state.timer.running;
    el.startPauseBtn.textContent = state.timer.running ? "â¸" : "â–¶";
    sfx("tap"); saveSoon();
  });
  el.stopBtn.addEventListener("click", ()=>{
    state.timer.running = false;
    el.startPauseBtn.textContent = "â–¶";
    sfx("tap"); saveSoon();
  });
  el.resetTimerBtn.addEventListener("click", ()=>{
    state.timer.running = false;
    state.timer.sec = 0;
    el.timerTxt.textContent = "00:00";
    el.startPauseBtn.textContent = "â–¶";
    sfx("tap"); saveSoon();
  });

  // Sound
  el.soundBtn.addEventListener("click", ()=>{
    state.sound = !state.sound;
    toast(state.sound ? "ğŸ”Š Ø§Ù„ØµÙˆØª Ø´ØºØ§Ù„" : "ğŸ”‡ Ø§Ù„ØµÙˆØª Ù…ÙƒØªÙˆÙ…");
    sfx("tap");
    render();
  });

  // New
  el.newBtn.addEventListener("click", ()=>{
    state = structuredClone(defaultState);
    sfx("clear");
    toast("â†º Ø¬Ø¯ÙŠØ¯");
    render();
  });

  // Edit names
  document.addEventListener("click",(e)=>{
    const key = e.target?.getAttribute?.("data-edit");
    if(!key) return;
    const cur = key==="us" ? state.usName : state.themName;
    const name = prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚:", cur);
    if(name==null) return;
    const v = name.trim();
    if(!v) return;
    if(key==="us") state.usName=v; else state.themName=v;
    sfx("tap");
    render();
  });

  // Init
  buildProjectsUI();
  render();
  // âœ… Calculator logic
const calc = {
  back: document.getElementById("calcBack"),
  close: document.getElementById("calcClose"),
  screen: document.getElementById("calcScreen"),
  clear: document.getElementById("calcClear"),
  backspace: document.getElementById("calcBackspace"),
  eq: document.getElementById("calcEq"),
};

function openCalc(){
  calc.screen.value = el.inAbnat.value ? String(el.inAbnat.value) : "";
  calc.back.style.display = "flex";

  // âœ… Ø®Ù„ÙŠ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ±Ø§ Ù…Ø¤Ù‚ØªÙ‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  el.modalBack.style.zIndex = "50";
  calc.back.style.zIndex = "9999";

  document.body.style.overflow = "hidden";
  sfx("tap");
}


function closeCalc(){
  calc.back.style.display = "none";
  document.body.style.overflow = "";
  sfx("tap");
}

function safeEval(expr){
  // Ø­Ù…Ø§ÙŠØ© Ø¨Ø³ÙŠØ·Ø©: Ù†Ø³Ù…Ø­ ÙÙ‚Ø· Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
  if(!/^[0-9+\-*/.() ]+$/.test(expr)) return null;
  try{
    // eslint-disable-next-line no-new-func
    const val = Function("return (" + expr + ")")();
    if(typeof val !== "number" || !isFinite(val)) return null;
    return val;
  }catch{
    return null;
  }
}

// Ù„Ù…Ø§ ØªØ¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¨Ù†Ø§Ø· ÙŠÙØªØ­ Ø§Ù„ÙƒØ§Ù„ÙƒÙˆÙ„ÙŠØªØ±
el.inAbnat.addEventListener("focus", (e)=>{
  e.target.blur();
  openCalc();
});

calc.close.addEventListener("click", closeCalc);
calc.back.addEventListener("click", (e)=>{ if(e.target===calc.back) closeCalc(); });

document.querySelectorAll(".cbtn[data-c]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const c = btn.getAttribute("data-c");
    calc.screen.value += c;
    sfx("tap");
  });
});

calc.clear.addEventListener("click", ()=>{
  calc.screen.value = "";
  sfx("clear");
});

calc.backspace.addEventListener("click", ()=>{
  calc.screen.value = calc.screen.value.slice(0,-1);
  sfx("tap");
});

calc.eq.addEventListener("click", ()=>{
  const expr = calc.screen.value.trim();
  if(!expr){ toast("Ø§ÙƒØªØ¨ Ø¹Ù…Ù„ÙŠØ©"); return; }

  const result = safeEval(expr);
  if(result===null){ toast("Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨"); return; }

  // Ù†Ø­Ø· Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„Ø£Ø¨Ù†Ø§Ø·
  const fixed = String(Math.round(result * 100) / 100); // ØªÙ‚Ø±ÙŠØ¨ Ø¨Ø³ÙŠØ·
  el.inAbnat.value = fixed;

  updateDetails();
  toast("âœ… ØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨");
  sfx("add");
  closeCalc();
});
})();
</script>
</body>
</html>
