<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Ø­Ø§Ø³Ø¨Ø© Ø¨Ù„ÙˆØª</title>
  <style>
    :root{
      --sand1:#fff7e6;
      --sand2:#f3e0b6;
      --card: rgba(255,255,255,.78);
      --card2: rgba(255,255,255,.62);
      --line: rgba(17,24,39,.10);
      --text: rgba(17,24,39,.92);
      --muted: rgba(17,24,39,.55);
      --gold:#c89b2d;
      --gold2:#e6c86f;
      --red:#ef4444;
      --green:#16a34a;
      --shadow: 0 12px 28px rgba(17,24,39,.12);
      --shadow2: 0 22px 70px rgba(17,24,39,.18);
      --r:18px;
      --r2:24px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Tahoma,Arial,sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(900px 520px at 50% -180px, rgba(200,155,45,.32), transparent 60%),
        radial-gradient(700px 360px at 14% 18%, rgba(230,200,111,.34), transparent 55%),
        linear-gradient(180deg,var(--sand1),var(--sand2));
    }
    .app{
      max-width: 520px;
      margin: 0 auto;
      padding: 14px 14px calc(18px + env(safe-area-inset-bottom));
    }

    /* Header */
    .header{
      position: sticky;
      top: 0;
      z-index: 10;
      padding-top: env(safe-area-inset-top);
      padding-bottom: 10px;
      background: linear-gradient(180deg, rgba(255,247,230,.96), rgba(255,247,230,.75), transparent);
      backdrop-filter: blur(10px);
    }
    .hRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .logo{
      width:42px;height:42px;
      border-radius:14px;
      border:1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:grid;place-items:center;
      flex: 0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:cover;display:block}
    .bTxt{min-width:0;line-height:1.1}
    .bTxt b{
      display:block;
      font-weight:1100;
      font-size:15px;
      color: var(--gold);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .bTxt small{
      display:block;
      margin-top:3px;
      color: var(--muted);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .hBtns{display:flex;gap:10px;flex:0 0 auto}
    .iconBtn{
      width:42px;height:42px;
      border-radius:16px;
      border:1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
      cursor:pointer;
      user-select:none;
      display:grid;place-items:center;
      font-weight:1000;
    }
    .iconBtn:active{transform:scale(.98)}
    .dangerBtn{
      padding: 11px 12px;
      border-radius: 16px;
      border: 1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.10);
      color: var(--red);
      box-shadow: var(--shadow);
      cursor:pointer;
      user-select:none;
      font-weight:1100;
    }
    .dangerBtn:active{transform:scale(.98)}

    /* Timer card */
    .timerCard{
      margin-top: 10px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, var(--card), var(--card2));
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .tTime{
      font-size:28px;
      font-weight:1200;
      letter-spacing:1px;
      padding: 8px 14px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.78);
      min-width: 120px;
      text-align:center;
    }
    .tGroup{display:flex;gap:10px}
    .tBtn{
      width:44px;height:44px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.86);
      box-shadow: 0 12px 24px rgba(17,24,39,.10);
      cursor:pointer;
      user-select:none;
      display:grid;place-items:center;
      font-weight:1200;
    }
    .tBtn:active{transform:scale(.98)}
    .tBtn.green{color:var(--green)}
    .tBtn.red{color:var(--red)}

    /* Scoreboard */
    .board{
      margin-top: 12px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.80), rgba(255,255,255,.62));
      border-radius: var(--r2);
      box-shadow: var(--shadow2);
      padding: 12px;
    }
    .meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-weight:1100;
      font-size:13px;
    }
    .meta b{color:var(--gold)}
    .bar{
      margin-top:10px;
      height:12px;
      border-radius:999px;
      background: rgba(17,24,39,.06);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .bar i{
      display:block;height:100%;width:0%;
      background: linear-gradient(90deg, rgba(230,200,111,.95), rgba(200,155,45,.95));
      border-radius:999px;
      transition: width .2s ease;
    }

    /* Two big team panels */
    .teams{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .team{
      border:1px solid var(--line);
      background: rgba(255,255,255,.82);
      border-radius: var(--r2);
      box-shadow: var(--shadow2);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 240px;
    }
    .teamTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      font-weight:1100;
    }
    .name{
      display:flex;align-items:center;gap:8px;min-width:0;
    }
    .name span{
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      font-size:15px;
    }
    .edit{
      width:36px;height:36px;border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.78);
      display:grid;place-items:center;
      cursor:pointer;user-select:none;
      font-weight:1200;
      opacity:.85;
    }
    .score{
      text-align:center;
      font-size:78px;
      font-weight:1300;
      line-height:1;
      margin: 0;
      letter-spacing:1px;
    }
    .team.red .score, .team.red .name span{color:var(--red)}
    .team.green .score, .team.green .name span{color:var(--green)}

    .addBig{
      margin-top:auto;
      width:100%;
      padding: 14px 12px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      box-shadow: 0 14px 30px rgba(17,24,39,.12);
      cursor:pointer;user-select:none;
      font-weight:1300;
      font-size:16px;
    }
    .addBig:active{transform:scale(.99)}

    /* Tabs */
    .tabs{
      margin-top: 12px;
      border:1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
      border-radius: var(--r2);
      padding: 8px;
      display:flex;
      gap:10px;
    }
    .tab{
      flex:1;
      padding: 11px 12px;
      border-radius: 16px;
      border:1px solid transparent;
      background: transparent;
      font-weight:1200;
      color: var(--muted);
      cursor:pointer;user-select:none;
    }
    .tab.active{
      background: rgba(255,255,255,.90);
      border-color: var(--line);
      color: var(--text);
      box-shadow: 0 12px 22px rgba(17,24,39,.10);
    }

    .box{
      margin-top: 12px;
      border:1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow2);
      border-radius: var(--r2);
      padding: 14px;
    }
    .boxHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      font-weight:1200;
    }
    .miniBtns{display:flex;gap:8px;flex-wrap:wrap}
    .mini{
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.86);
      box-shadow: 0 12px 22px rgba(17,24,39,.10);
      cursor:pointer;user-select:none;
      font-weight:1200;
      font-size:13px;
    }
    .mini:active{transform:scale(.98)}
    .mini.danger{
      border-color: rgba(239,68,68,.25);
      background: rgba(239,68,68,.10);
      color: var(--red);
    }

    .empty{padding:26px 10px;text-align:center;color:var(--muted);font-weight:1200}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .row{
      border:1px solid var(--line);
      background: rgba(255,255,255,.86);
      border-radius: 18px;
      padding: 12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      font-weight:1200;
    }
    .row small{color:var(--muted);font-weight:1100}

    /* Bottom sheet modal */
    .backdrop{
      position:fixed; inset:0;
      display:none;
      align-items:flex-end; justify-content:center;
      background: rgba(17,24,39,.36);
      z-index: 50;
    }
    .sheet{
      width:100%;
      max-width:520px;
      border-radius: 26px 26px 0 0;
      background: #fffaf0;
      border:1px solid var(--line);
      box-shadow: 0 -22px 80px rgba(17,24,39,.26);
      max-height: 88vh;
      overflow:auto;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .sHead{
      position: sticky; top:0;
      background: #fff4d7;
      border-bottom:1px solid var(--line);
      padding: 12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .sTitle{font-weight:1300;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .close{
      width:44px;height:44px;border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.90);
      display:grid;place-items:center;
      cursor:pointer;user-select:none;
      font-weight:1200;
    }
    .sBody{padding: 14px; display:flex; flex-direction:column; gap:12px;}

    label{display:block;font-size:12px;color:var(--muted);font-weight:1200;margin:0 0 6px;}
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      font-weight:1300;
      font-size:15px;
      outline:none;
    }
    .seg{
      display:flex; gap:8px; padding:6px;
      border-radius:999px; border:1px solid var(--line);
      background: rgba(255,255,255,.86);
    }
    .seg button{
      flex:1;
      border-radius:999px;
      border:1px solid transparent;
      background: transparent;
      padding: 11px 10px;
      cursor:pointer; user-select:none;
      font-weight:1300;
      color: var(--muted);
    }
    .seg button.active{
      background: #fff4d7;
      border-color: rgba(200,155,45,.22);
      color: var(--text);
      box-shadow: 0 10px 18px rgba(17,24,39,.08);
    }
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .hint{
      color: var(--muted);
      font-weight:1100;
      font-size:12px;
      line-height:1.5;
    }
    .preview{
      border-top:1px solid var(--line);
      padding-top:12px;
      color: var(--muted);
      font-weight:1200;
      font-size:13px;
      line-height:1.65;
      white-space:pre-line;
    }
    .sActions{
      padding: 0 14px 14px;
      display:flex; gap:10px;
    }
    .sActions button{
      flex:1;
      padding: 14px 12px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      box-shadow: 0 14px 24px rgba(17,24,39,.10);
      cursor:pointer; user-select:none;
      font-weight:1300;
    }
    .sActions button:active{transform:scale(.99)}
    .primary{
      background: linear-gradient(180deg, rgba(255,244,215,1), rgba(255,255,255,.92));
      border-color: rgba(200,155,45,.25);
    }

    /* Toast */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: 18px;
      padding:10px 12px;
      border-radius:999px;
      background:#111827;
      color:#fff;
      box-shadow: 0 18px 55px rgba(0,0,0,.25);
      font-weight:1300;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index: 90;
      max-width: calc(100vw - 24px);
      text-align:center;
    }
    .toast.show{opacity:1}

    @media (max-width:390px){
      .score{font-size:70px}
      .team{min-height:230px}
      .tTime{min-width:110px}
    }
  </style>
</head>

<body>
  <div class="app">

    <div class="header">
      <div class="hRow">
        <div class="brand">
          <div class="logo" title="Ù„ÙˆØºÙˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            <img src="logo.png" alt="" onerror="this.style.display='none'">
          </div>
          <div class="bTxt">
            <b>Ø­Ø§Ø³Ø¨Ø© Ø¨Ù„ÙˆØª</b>
            <small>ÙˆØ§Ø¬Ù‡Ø© Ø¢ÙŠÙÙˆÙ† â€” Ø³Ø±ÙŠØ¹Ø© ÙˆØ®ÙÙŠÙØ©</small>
          </div>
        </div>

        <div class="hBtns">
          <div class="iconBtn" id="soundBtn" title="ØµÙˆØª">ğŸ”Š</div>
          <button class="dangerBtn" id="newBtn">Ø¬Ø¯ÙŠØ¯ â†º</button>
        </div>
      </div>

      <div class="timerCard">
        <div class="tGroup">
          <div class="tBtn red" id="resetTimerBtn" title="ØªØµÙÙŠØ±">â†º</div>
          <div class="tBtn green" id="startPauseBtn" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù">â–¶</div>
        </div>
        <div class="tTime" id="timerTxt">00:00</div>
        <div class="tGroup">
          <div class="tBtn" id="stopBtn" title="Ø¥ÙŠÙ‚Ø§Ù">â±</div>
        </div>
      </div>

      <div class="board">
        <div class="meta">
          <span>Ø§Ù„Ø¬ÙˆÙ„Ø© <b id="roundNo">0</b></span>
          <span>Ø§Ù„Ù‡Ø¯Ù <b id="goalTxt">152</b></span>
        </div>
        <div class="bar"><i id="barFill"></i></div>
      </div>
    </div>

    <div class="teams">
      <div class="team red">
        <div class="teamTop">
          <div class="name"><span id="themName">Ù‡Ù…</span></div>
          <div class="edit" data-edit="them" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…">âœ</div>
        </div>
        <div class="score" id="themScore">0</div>
        <button class="addBig" id="addThem">Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø© +</button>
      </div>

      <div class="team green">
        <div class="teamTop">
          <div class="name"><span id="usName">Ù†Ø­Ù†</span></div>
          <div class="edit" data-edit="us" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…">âœ</div>
        </div>
        <div class="score" id="usScore">0</div>
        <button class="addBig" id="addUs">Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø© +</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabHistory">â†© Ø§Ù„Ø³Ø¬Ù„</button>
      <button class="tab" id="tabStats">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
    </div>

    <div class="box" id="historyBox">
      <div class="boxHead">
        <div>Ø§Ù„Ø³Ø¬Ù„ (<span id="count">0</span>)</div>
        <div class="miniBtns">
          <button class="mini" id="undoBtn">â†© ØªØ±Ø§Ø¬Ø¹</button>
          <button class="mini" id="shareBtn">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</button>
          <button class="mini danger" id="clearBtn">ğŸ—‘ Ù…Ø³Ø­</button>
        </div>
      </div>
      <div id="historyBody" class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„</div>
    </div>

    <div class="box" id="statsBox" style="display:none;">
      <div class="boxHead"><div>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div></div>
      <div class="list">
        <div class="row"><div>Ù…Ø¬Ù…ÙˆØ¹ Ù†Ø­Ù†</div><div><b id="stUs">0</b></div></div>
        <div class="row"><div>Ù…Ø¬Ù…ÙˆØ¹ Ù‡Ù…</div><div><b id="stThem">0</b></div></div>
        <div class="row"><div>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div><div><b id="stAdds">0</b></div></div>
        <div class="row"><div>Ø£Ø¹Ù„Ù‰ Ø³Ø¬Ù„</div><div><b id="stMax">0</b></div></div>
      </div>
    </div>

  </div>

  <div class="toast" id="toast">âœ… ØªÙ…</div>

  <!-- Bottom Sheet -->
  <div class="backdrop" id="modalBack">
    <div class="sheet">
      <div class="sHead">
        <div class="sTitle" id="mTitle">Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø©</div>
        <div class="close" id="mClose">âœ•</div>
      </div>

      <div class="sBody">
        <div>
          <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</label>
          <div class="seg">
            <button id="mManual" class="active">ÙŠØ¯ÙˆÙŠ</button>
            <button id="mAdv">Ù…ØªÙ‚Ø¯Ù…</button>
          </div>
        </div>

        <!-- Manual -->
        <div id="boxManual">
          <div class="grid2">
            <div>
              <label id="labUs">Ù†Ù‚Ø§Ø· Ù†Ø­Ù†</label>
              <input id="inUs" type="number" min="0" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 30">
            </div>
            <div>
              <label id="labThem">Ù†Ù‚Ø§Ø· Ù‡Ù…</label>
              <input id="inThem" type="number" min="0" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 20">
            </div>
          </div>
        </div>

        <!-- Advanced -->
        <div id="boxAdv" style="display:none;">
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„Ù„Ø¹Ø¨Ø©</label>
            <div class="seg">
              <button id="modeSan" class="active">ØµÙ† (120)</button>
              <button id="modeHokm">Ø­ÙƒÙ… (150)</button>
            </div>
          </div>

          <div>
            <label id="labAbnat">Ø£Ø¨Ù†Ø§Ø· Ø§Ù„ÙØ±ÙŠÙ‚</label>
            <input id="inAbnat" type="number" min="0" inputmode="numeric" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø¨Ù†Ø§Ø· Ù„ÙØ±ÙŠÙ‚Ùƒ">
            <div class="hint">ØµÙ† Ã·5 ØŒ Ø­ÙƒÙ… Ã·10 â€” Ø§Ù„Ø®ØµÙ… = Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ - Ø£Ø¨Ù†Ø§Ø·Ùƒ</div>
          </div>

          <div class="grid2">
            <div>
              <label id="labProjA">Ù…Ø´Ø§Ø±ÙŠØ¹ ÙØ±ÙŠÙ‚Ùƒ</label>
              <select id="projA"></select>
              <input id="projAC" type="number" min="0" inputmode="numeric" placeholder="Ø§Ù„Ø¹Ø¯Ø¯ (Ù…Ø«Ø§Ù„: 2)" style="margin-top:8px;">
            </div>
            <div>
              <label id="labProjB">Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø®ØµÙ…</label>
              <select id="projB"></select>
              <input id="projBC" type="number" min="0" inputmode="numeric" placeholder="Ø§Ù„Ø¹Ø¯Ø¯ (Ù…Ø«Ø§Ù„: 2)" style="margin-top:8px;">
            </div>
          </div>

          <div>
            <label>Ø§Ù„Ø£Ø±Ø¶</label>
            <div class="seg">
              <button id="ardA" class="active">Ù„ÙØ±ÙŠÙ‚Ùƒ</button>
              <button id="ardB">Ù„Ù„Ø®ØµÙ…</button>
            </div>
            <div class="hint">Ø§Ù„Ø£Ø±Ø¶: ØµÙ† +2 â€” Ø­ÙƒÙ… +1</div>
          </div>

          <div class="preview" id="previewTxt"></div>
        </div>
      </div>

      <div class="sActions">
        <button id="mClear">Ù…Ø³Ø­</button>
        <button class="primary" id="mAdd">Ø¥Ø¶Ø§ÙØ©</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const LS = "baloot_phone_easy_v1";
  const $ = (id)=>document.getElementById(id);

  const el = {
    roundNo: $("roundNo"), goalTxt: $("goalTxt"), barFill: $("barFill"),
    usName: $("usName"), themName: $("themName"),
    usScore: $("usScore"), themScore: $("themScore"),

    timerTxt: $("timerTxt"),
    startPauseBtn: $("startPauseBtn"), stopBtn: $("stopBtn"), resetTimerBtn: $("resetTimerBtn"),

    addUs: $("addUs"), addThem: $("addThem"),

    tabHistory: $("tabHistory"), tabStats: $("tabStats"),
    historyBox: $("historyBox"), statsBox: $("statsBox"),
    historyBody: $("historyBody"), count: $("count"),
    undoBtn: $("undoBtn"), clearBtn: $("clearBtn"), shareBtn: $("shareBtn"), newBtn: $("newBtn"),

    soundBtn: $("soundBtn"),
    toast: $("toast"),

    stUs: $("stUs"), stThem: $("stThem"), stAdds: $("stAdds"), stMax: $("stMax"),

    // modal
    modalBack: $("modalBack"), mTitle: $("mTitle"), mClose: $("mClose"),
    mManual: $("mManual"), mAdv: $("mAdv"),
    boxManual: $("boxManual"), boxAdv: $("boxAdv"),
    labUs: $("labUs"), labThem: $("labThem"),
    inUs: $("inUs"), inThem: $("inThem"),
    modeSan: $("modeSan"), modeHokm: $("modeHokm"),
    labAbnat: $("labAbnat"), inAbnat: $("inAbnat"),
    projA: $("projA"), projB: $("projB"),
    projAC: $("projAC"), projBC: $("projBC"),
    labProjA: $("labProjA"), labProjB: $("labProjB"),
    ardA: $("ardA"), ardB: $("ardB"),
    previewTxt: $("previewTxt"),
    mAdd: $("mAdd"), mClear: $("mClear"),
  };

  const defaultState = {
    goal: 152,
    usName: "Ù†Ø­Ù†",
    themName: "Ù‡Ù…",
    round: 0,
    entries: [], // {round, timeSec, usPts, themPts, note}
    timer: { sec:0, running:false },
    sound: true,
  };

  function load(){
    try{
      const raw = localStorage.getItem(LS);
      if(!raw) return structuredClone(defaultState);
      const s = JSON.parse(raw);
      if(!s || typeof s!=="object") return structuredClone(defaultState);
      if(typeof s.goal!=="number") s.goal=152;
      if(typeof s.usName!=="string") s.usName="Ù†Ø­Ù†";
      if(typeof s.themName!=="string") s.themName="Ù‡Ù…";
      if(typeof s.round!=="number") s.round=0;
      if(!Array.isArray(s.entries)) s.entries=[];
      if(!s.timer) s.timer={sec:0,running:false};
      if(typeof s.timer.sec!=="number") s.timer.sec=0;
      if(typeof s.timer.running!=="boolean") s.timer.running=false;
      if(typeof s.sound!=="boolean") s.sound=true;
      return s;
    }catch{
      return structuredClone(defaultState);
    }
  }

  let state = load();

  let saveT=null;
  function saveSoon(){
    if(saveT) return;
    saveT=setTimeout(()=>{
      saveT=null;
      localStorage.setItem(LS, JSON.stringify(state));
    }, 400);
  }

  let audioCtx=null;
  function beep(){
    if(!state.sound) return;
    try{
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const o=audioCtx.createOscillator();
      const g=audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      const now=audioCtx.currentTime;
      o.type="sine";
      o.frequency.setValueAtTime(650, now);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.10, now+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.12);
      o.start(now); o.stop(now+0.14);
    }catch{}
  }
  function toast(msg){
    el.toast.textContent = msg;
    el.toast.classList.add("show");
    setTimeout(()=>el.toast.classList.remove("show"), 900);
  }

  function fmt(sec){
    sec = Math.max(0, sec|0);
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }

  function sum(){
    let us=0, them=0;
    for(const e of state.entries){ us += (e.usPts||0); them += (e.themPts||0); }
    return {us, them};
  }

  function render(){
    el.goalTxt.textContent = state.goal;
    el.roundNo.textContent = state.round;

    el.usName.textContent = state.usName;
    el.themName.textContent = state.themName;

    const {us, them} = sum();
    el.usScore.textContent = us;
    el.themScore.textContent = them;

    const lead = Math.max(us, them);
    const prog = Math.min(100, Math.floor((lead / state.goal) * 100)) || 0;
    el.barFill.style.width = prog + "%";

    el.timerTxt.textContent = fmt(state.timer.sec||0);
    el.startPauseBtn.textContent = state.timer.running ? "â¸" : "â–¶";

    el.count.textContent = state.entries.length;

    // history last 30
    if(state.entries.length===0){
      el.historyBody.className="empty";
      el.historyBody.textContent="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„";
    }else{
      el.historyBody.className="list";
      el.historyBody.innerHTML="";
      const slice = state.entries.slice(-30).reverse();
      for(const e of slice){
        const row=document.createElement("div");
        row.className="row";
        row.innerHTML = `
          <div>
            <div><small>â± ${fmt(e.timeSec||0)} â€” Ø¬ÙˆÙ„Ø© ${e.round}</small></div>
            <div><small>${e.note||""}</small></div>
          </div>
          <div style="text-align:left">
            <div><b>${state.usName}: ${e.usPts||0}</b></div>
            <div><b>${state.themName}: ${e.themPts||0}</b></div>
          </div>
        `;
        el.historyBody.appendChild(row);
      }
    }

    // stats
    el.stUs.textContent = us;
    el.stThem.textContent = them;
    el.stAdds.textContent = state.entries.length;
    let mx=0; for(const e of state.entries) mx = Math.max(mx, e.usPts||0, e.themPts||0);
    el.stMax.textContent = mx;

    el.soundBtn.textContent = state.sound ? "ğŸ”Š" : "ğŸ”‡";
    saveSoon();
  }

  // Timer tick (only update time text)
  setInterval(()=>{
    if(!state.timer.running) return;
    state.timer.sec = (state.timer.sec||0)+1;
    el.timerTxt.textContent = fmt(state.timer.sec||0);
    saveSoon();
  }, 1000);

  // Modal logic
  let modalTeam = "us";     // clicked team
  let inputMode = "manual"; // manual|adv
  let advMode = "san";      // san|hokm
  let ardTo = "A";          // A=team, B=opponent

  const projSan = [
    ["", "Ø¨Ø¯ÙˆÙ†", 0],
    ["sra","Ø³Ø±Ø§ (+4)",4],
    ["50","Ø®Ù…Ø³ÙŠÙ† (+10)",10],
    ["100","Ù…ÙŠØ© (+20)",20],
    ["400","400 (+40)",40],
  ];
  const projHokm = [
    ["", "Ø¨Ø¯ÙˆÙ†", 0],
    ["sra","Ø³Ø±Ø§ (+2)",2],
    ["50","Ø®Ù…Ø³ÙŠÙ† (+5)",5],
    ["100","Ù…ÙŠØ© (+10)",10],
    ["baloot","Ø¨Ù„ÙˆØª (+2)",2],
  ];

  function totalAbnat(){ return advMode==="hokm" ? 150 : 120; }
  function divisor(){ return advMode==="hokm" ? 10 : 5; }
  function ardBonus(){ return advMode==="hokm" ? 1 : 2; }

  function fillProjects(){
    const arr = advMode==="hokm" ? projHokm : projSan;
    const fill = (sel)=>{
      sel.innerHTML="";
      for(const [k,lab] of arr){
        const opt=document.createElement("option");
        opt.value=k; opt.textContent=lab;
        sel.appendChild(opt);
      }
      sel.value="";
    };
    fill(el.projA); fill(el.projB);
    el.projAC.value=""; el.projBC.value="";
  }

  function projPts(key){
    const arr = advMode==="hokm" ? projHokm : projSan;
    for(const [k,_,p] of arr) if(k===key) return p;
    return 0;
  }
  function projTotal(sel, cntInput){
    const key = sel.value || "";
    const c = Math.max(0, parseInt(cntInput.value||"0",10) || 0);
    if(!key || c===0) return 0;
    return projPts(key)*c;
  }

  function setInputMode(m){
    inputMode = m;
    el.mManual.classList.toggle("active", m==="manual");
    el.mAdv.classList.toggle("active", m==="adv");
    el.boxManual.style.display = m==="manual" ? "" : "none";
    el.boxAdv.style.display = m==="adv" ? "" : "none";
  }

  function setAdvMode(m){
    advMode = m;
    el.modeSan.classList.toggle("active", m==="san");
    el.modeHokm.classList.toggle("active", m==="hokm");

    fillProjects();

    const teamName = modalTeam==="us" ? state.usName : state.themName;
    const oppName  = modalTeam==="us" ? state.themName : state.usName;
    el.labAbnat.textContent = `Ø£Ø¨Ù†Ø§Ø· ${teamName}`;
    el.labProjA.textContent = `Ù…Ø´Ø§Ø±ÙŠØ¹ ${teamName}`;
    el.labProjB.textContent = `Ù…Ø´Ø§Ø±ÙŠØ¹ ${oppName}`;
  }

  function openModal(team){
    modalTeam = team;
    const teamName = team==="us" ? state.usName : state.themName;
    el.mTitle.textContent = `Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø© â€” ${teamName}`;

    el.labUs.textContent = `Ù†Ù‚Ø§Ø· ${state.usName}`;
    el.labThem.textContent = `Ù†Ù‚Ø§Ø· ${state.themName}`;

    // reset
    ardTo="A"; advMode="san";
    setInputMode("manual");
    setAdvMode("san");
    el.inUs.value=""; el.inThem.value="";
    el.inAbnat.value=""; el.previewTxt.textContent="";
    el.ardA.classList.add("active"); el.ardB.classList.remove("active");

    el.modalBack.style.display="flex";
    document.body.style.overflow="hidden";
  }
  function closeModal(){
    el.modalBack.style.display="none";
    document.body.style.overflow="";
  }

  function computeAdv(){
    const v = parseInt(el.inAbnat.value||"",10);
    const has = !Number.isNaN(v) && el.inAbnat.value!=="";
    const yourAb = has ? Math.max(0, v) : 0;

    const total = totalAbnat();
    const otherAb = Math.max(0, total - yourAb);

    const d = divisor();
    const yourPtsAb = has ? Math.floor(yourAb / d) : 0;
    const otherPtsAb = has ? Math.floor(otherAb / d) : 0;

    const aProj = projTotal(el.projA, el.projAC);
    const bProj = projTotal(el.projB, el.projBC);

    const bonus = (has || aProj>0 || bProj>0) ? ardBonus() : 0;

    const teamName = modalTeam==="us" ? state.usName : state.themName;
    const oppName  = modalTeam==="us" ? state.themName : state.usName;

    const teamPts = yourPtsAb + aProj + (ardTo==="A" ? bonus : 0);
    const oppPts  = otherPtsAb + bProj + (ardTo==="B" ? bonus : 0);

    const usPts   = (modalTeam==="us") ? teamPts : oppPts;
    const themPts = (modalTeam==="them") ? teamPts : oppPts;

    const note =
      `Ù…ØªÙ‚Ø¯Ù… (${advMode==="san"?"ØµÙ†":"Ø­ÙƒÙ…"}) â€” ` +
      `${teamName}: Ø£Ø¨Ù†Ø§Ø· ${yourAb}/${total} => ${yourPtsAb} + Ù…Ø´Ø§Ø±ÙŠØ¹ ${aProj}` +
      `${ardTo==="A" ? ` + Ø£Ø±Ø¶ ${bonus}` : ""} | ` +
      `${oppName}: Ø£Ø¨Ù†Ø§Ø· ${otherAb}/${total} => ${otherPtsAb} + Ù…Ø´Ø§Ø±ÙŠØ¹ ${bProj}` +
      `${ardTo==="B" ? ` + Ø£Ø±Ø¶ ${bonus}` : ""}`;

    return {has, teamName, oppName, yourAb, otherAb, total, d, yourPtsAb, otherPtsAb, aProj, bProj, bonus, usPts, themPts, note};
  }

  function updatePreview(){
    if(inputMode!=="adv"){ el.previewTxt.textContent=""; return; }
    const r = computeAdv();
    if(!r.has && r.aProj===0 && r.bProj===0){
      el.previewTxt.textContent = `Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø¨Ù†Ø§Ø· Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ø´Ø§Ø±ÙŠØ¹.\nØ§Ù„ØµÙ†: 120 Ã·5 â€” Ø§Ù„Ø­ÙƒÙ…: 150 Ã·10`;
      return;
    }
    el.previewTxt.textContent =
      `${r.teamName}: Ø£Ø¨Ù†Ø§Ø· ${r.yourAb}/${r.total} => ${r.yourPtsAb} (Ã·${r.d})\n` +
      `${r.oppName}: Ø£Ø¨Ù†Ø§Ø· ${r.otherAb}/${r.total} => ${r.otherPtsAb} (Ã·${r.d})\n` +
      `Ù…Ø´Ø§Ø±ÙŠØ¹ ${r.teamName}: +${r.aProj} â€” Ù…Ø´Ø§Ø±ÙŠØ¹ ${r.oppName}: +${r.bProj}\n` +
      `Ø§Ù„Ø£Ø±Ø¶: +${r.bonus} Ù„Ù€ ${ardTo==="A"?r.teamName:r.oppName}\n` +
      `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${state.usName}=${r.usPts} | ${state.themName}=${r.themPts}`;
  }

  function addEntry(usPts, themPts, note){
    state.round = (state.round||0)+1;
    state.entries.push({
      round: state.round,
      timeSec: state.timer.sec||0,
      usPts, themPts,
      note: note||""
    });
    if(!state.timer.running){
      state.timer.running = true;
      el.startPauseBtn.textContent = "â¸";
    }
    beep(); toast("âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
    render();
  }

  // Buttons â€” IMPORTANT: this is what makes "Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø©" work
  el.addUs.addEventListener("click", ()=>openModal("us"));
  el.addThem.addEventListener("click", ()=>openModal("them"));

  el.mClose.addEventListener("click", closeModal);
  el.modalBack.addEventListener("click",(e)=>{ if(e.target===el.modalBack) closeModal(); });

  el.mManual.addEventListener("click", ()=>{ setInputMode("manual"); beep(); });
  el.mAdv.addEventListener("click", ()=>{ setInputMode("adv"); updatePreview(); beep(); });

  el.modeSan.addEventListener("click", ()=>{ setAdvMode("san"); updatePreview(); beep(); });
  el.modeHokm.addEventListener("click", ()=>{ setAdvMode("hokm"); updatePreview(); beep(); });

  el.inAbnat.addEventListener("input", updatePreview);
  el.projA.addEventListener("change", updatePreview);
  el.projB.addEventListener("change", updatePreview);
  el.projAC.addEventListener("input", updatePreview);
  el.projBC.addEventListener("input", updatePreview);

  el.ardA.addEventListener("click", ()=>{ ardTo="A"; el.ardA.classList.add("active"); el.ardB.classList.remove("active"); updatePreview(); beep(); });
  el.ardB.addEventListener("click", ()=>{ ardTo="B"; el.ardB.classList.add("active"); el.ardA.classList.remove("active"); updatePreview(); beep(); });

  el.mClear.addEventListener("click", ()=>{
    el.inUs.value=""; el.inThem.value="";
    el.inAbnat.value="";
    el.projA.value=""; el.projB.value="";
    el.projAC.value=""; el.projBC.value="";
    ardTo="A"; el.ardA.classList.add("active"); el.ardB.classList.remove("active");
    updatePreview();
    beep(); toast("ğŸ§¹ ØªÙ…");
  });

  el.mAdd.addEventListener("click", ()=>{
    if(inputMode==="manual"){
      const us = Math.max(0, parseInt(el.inUs.value||"0",10) || 0);
      const them = Math.max(0, parseInt(el.inThem.value||"0",10) || 0);
      if(us===0 && them===0){ toast("Ø§ÙƒØªØ¨ Ù†Ù‚Ø§Ø·"); return; }
      addEntry(us, them, "ÙŠØ¯ÙˆÙŠ");
      closeModal();
    }else{
      const r = computeAdv();
      if(!r.has && r.aProj===0 && r.bProj===0){ toast("Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø¨Ù†Ø§Ø· Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ø´Ø§Ø±ÙŠØ¹"); return; }
      addEntry(r.usPts, r.themPts, r.note);
      closeModal();
    }
  });

  // Edit names
  document.addEventListener("click",(e)=>{
    const key = e.target?.getAttribute?.("data-edit");
    if(!key) return;
    const cur = key==="us" ? state.usName : state.themName;
    const name = prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚:", cur);
    if(name==null) return;
    const v = name.trim();
    if(!v) return;
    if(key==="us") state.usName=v; else state.themName=v;
    beep(); render();
  });

  // Tabs
  el.tabHistory.addEventListener("click", ()=>{
    el.tabHistory.classList.add("active");
    el.tabStats.classList.remove("active");
    el.historyBox.style.display="";
    el.statsBox.style.display="none";
  });
  el.tabStats.addEventListener("click", ()=>{
    el.tabStats.classList.add("active");
    el.tabHistory.classList.remove("active");
    el.historyBox.style.display="none";
    el.statsBox.style.display="";
  });

  // Timer controls
  el.startPauseBtn.addEventListener("click", ()=>{
    state.timer.running = !state.timer.running;
    el.startPauseBtn.textContent = state.timer.running ? "â¸" : "â–¶";
    beep(); saveSoon();
  });
  el.stopBtn.addEventListener("click", ()=>{
    state.timer.running = false;
    el.startPauseBtn.textContent = "â–¶";
    beep(); saveSoon();
  });
  el.resetTimerBtn.addEventListener("click", ()=>{
    state.timer.running = false;
    state.timer.sec = 0;
    el.timerTxt.textContent = "00:00";
    el.startPauseBtn.textContent = "â–¶";
    beep(); saveSoon();
  });

  // Undo/Clear/New
  el.undoBtn.addEventListener("click", ()=>{
    if(state.entries.length===0) return;
    state.entries.pop();
    state.round = Math.max(0, (state.round||0)-1);
    beep(); toast("â†© ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹"); render();
  });
  el.clearBtn.addEventListener("click", ()=>{
    state.entries=[]; state.round=0;
    beep(); toast("ğŸ—‘ ØªÙ… Ø§Ù„Ù…Ø³Ø­"); render();
  });
  el.newBtn.addEventListener("click", ()=>{
    state = structuredClone(defaultState);
    beep(); toast("â†º Ø¬Ø¯ÙŠØ¯"); render();
  });

  // Share
  el.shareBtn.addEventListener("click", async ()=>{
    const {us, them} = sum();
    const lines = [];
    lines.push("Ø­Ø§Ø³Ø¨Ø© Ø¨Ù„ÙˆØª");
    lines.push(`${state.usName}: ${us} | ${state.themName}: ${them}`);
    lines.push(`Ø³Ø¬Ù„Ø§Øª: ${state.entries.length}`);
    lines.push("â€” â€” â€”");
    for(const e of state.entries){
      lines.push(`Ø¬ÙˆÙ„Ø© ${e.round} â± ${fmt(e.timeSec||0)} | ${state.usName}:${e.usPts} ${state.themName}:${e.themPts}`);
      if(e.note) lines.push(`  ${e.note}`);
    }
    const text = lines.join("\n");
    try{ if(navigator.share){ await navigator.share({text}); return; } }catch{}
    try{ await navigator.clipboard.writeText(text); toast("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®"); }catch{ toast("Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§"); }
  });

  // Sound
  el.soundBtn.addEventListener("click", ()=>{
    state.sound = !state.sound;
    toast(state.sound ? "ğŸ”Š Ø§Ù„ØµÙˆØª Ø´ØºØ§Ù„" : "ğŸ”‡ Ø§Ù„ØµÙˆØª Ù…ÙƒØªÙˆÙ…");
    render();
  });

  // Init modal selects
  fillProjects();

  // Live preview
  ["input","change"].forEach(ev=>{
    el.inAbnat.addEventListener(ev, updatePreview);
    el.projA.addEventListener(ev, updatePreview);
    el.projB.addEventListener(ev, updatePreview);
    el.projAC.addEventListener(ev, updatePreview);
    el.projBC.addEventListener(ev, updatePreview);
  });

  render();
})();
</script>
</body>
</html>
